<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>MULTAs v2.2 [SAFETY MODE] - 医学実習レポート自動生成システム（安定版）</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF生成用ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* === ベーススタイル === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: linear-gradient(135deg, #81c784 0%, #b39ddb 100%);
            height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        /* === ヘッダー === */
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            text-align: center;
            color: white;
            flex-shrink: 0;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* === 日付選択 === */
        .day-selector {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .day-display {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: #7e57c2;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(126, 87, 194, 0.3);
        }

        .day-display:hover {
            background: #673ab7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(126, 87, 194, 0.4);
        }

        .day-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow: hidden;
            display: none;
            white-space: nowrap;
        }

        .day-dropdown.active {
            display: flex;
            flex-direction: row;
            gap: 2px;
            padding: 8px;
        }

        .day-option {
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.85rem;
            color: white;
            border-radius: 4px;
        }

        .day-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .day-option.selected {
            background: #7e57c2;
            color: white;
        }

        /* === モニター切り替えタブ === */
        .monitor-tabs {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            justify-content: center;
        }

        .monitor-tab {
            padding: 10px 24px;
            border: 2px solid #4a9eff;
            background: white;
            color: #4a9eff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 25px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 140px;
            text-align: center;
        }

        .monitor-tab:hover {
            background: #e8f2ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.2);
        }

        .monitor-tab.active {
            background: #66bb6a;
            color: white;
            border-color: #66bb6a;
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }

        /* === メインコンテンツエリア === */
        .main-content {
            flex: 1;
            padding: 0;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* === 統計固定エリア === */
        .monitor-stats {
            background: white;
            padding: 12px 20px 8px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
            overflow: visible;
            position: relative;
            z-index: 100;
        }

        /* === スクロール可能コンテンツ === */
        .monitor-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            min-height: 0;
        }

        /* === モニター表示 === */
        .monitor {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .monitor.active {
            display: flex;
        }

        .monitor h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 6px;
            margin: 0 0 15px 0;
        }

        /* === 統計カード === */
        .stats-grid {
            display: flex;
            gap: 6px;
            margin-bottom: 0;
            align-items: center;
        }

        .exp-bar-container {
            flex: 1;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-left: 10px;
        }

        .exp-bar {
            height: 100%;
            background: linear-gradient(90deg, #b39ddb 0%, #9575cd 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 4px rgba(179, 157, 219, 0.3);
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: 600;
            font-size: 0.8rem;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        .stat-card {
            background: rgba(179, 157, 219, 0.08);
            border-radius: 5px;
            padding: 4px 8px;
            text-align: center;
            border: 1px solid rgba(179, 157, 219, 0.12);
            flex: 1;
            min-width: 60px;
            max-width: 80px;
        }

        .stat-number {
            font-size: 0.85rem;
            font-weight: bold;
            color: #7e57c2;
            margin-bottom: 1px;
        }

        .stat-label {
            color: #999;
            font-size: 0.65rem;
            line-height: 1.1;
        }

        /* === 記録アイテム === */
        .record-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .record-item:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left-color: #5a67d8;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .record-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .record-timestamp {
            color: #666;
            font-size: 0.8rem;
        }

        .record-actions {
            display: flex;
            gap: 6px;
        }

        .record-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .record-btn:hover {
            background: #f5f5f5;
            border-color: #999;
            transform: translateY(-1px);
        }

        .edit-btn {
            color: #555;
        }

        .delete-btn {
            color: #666;
        }

        .save-btn {
            background: #4a9eff;
            color: white;
            border-color: #4a9eff;
        }

        .save-btn:hover {
            background: #357abd;
            border-color: #357abd;
        }

        .cancel-btn {
            color: #888;
        }

        .record-text {
            line-height: 1.8;
            font-size: 1.2rem;
            color: #333;
            font-weight: 500;
            word-wrap: break-word;
            letter-spacing: 0.02em;
        }

        .record-category {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .record-ai-indicator {
            display: inline-block;
            margin-left: 8px;
            padding: 3px 7px;
            background: #4caf50;
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* === カテゴリ別表示 === */
        .category-section {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .category-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-content {
            padding: 15px;
        }

        .category-item {
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .category-item .category-text {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            font-weight: 500;
            word-wrap: break-word;
            letter-spacing: 0.02em;
        }

        /* 要素分配表示用のスタイル */
        .element-display {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .element-weight-badge {
            position: absolute;
            left: 0;
            top: 0;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .element-text {
            flex: 1;
            font-size: 1.15rem;
            line-height: 1.5;
            color: #333;
            font-weight: 500;
            word-wrap: break-word;
            letter-spacing: 0.02em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* 理由アイコンと吹き出し */
        .reason-icon {
            flex-shrink: 0;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: all 0.3s ease;
            padding: 4px;
        }

        .reason-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .element-reason {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            left: auto;
            width: 90%;
            max-width: 400px;
            margin-top: 0;
            padding: 12px 30px 12px 15px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            animation: fadeIn 0.3s ease;
        }

        .element-reason::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #667eea;
        }

        .reason-close {
            position: absolute;
            top: 8px;
            right: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .reason-close:hover {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* === 要素分解表示 === */
        .elements-breakdown {
            margin-top: 10px;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .elements-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .element-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .element-item:last-child {
            border-bottom: none;
        }
        
        .element-category {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .element-content {
            flex: 1;
            color: #4a5568;
        }
        
        .element-weight {
            color: #667eea;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* === レポート表示 === */
        .report-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .report-section {
            margin-bottom: 20px;
        }

        .report-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 4px;
        }
        
        /* AIフィードバックのスタイル */
        .ai-feedback {
            background: linear-gradient(135deg, #f5f7ff 0%, #fef5ff 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            font-size: 1.05rem;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .ai-feedback p {
            margin-bottom: 1em;
        }
        
        .ai-feedback:last-child {
            margin-bottom: 0;
        }
        
        /* === レポート内のLIST形式スタイル === */
        .report-list-content {
            margin-top: 15px;
        }
        
        .report-category-section {
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .report-category-header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .report-category-content {
            padding: 15px;
        }
        
        .report-category-item {
            background: white;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }
        
        .report-category-item:last-child {
            margin-bottom: 0;
        }
        
        .report-element-text {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
        }
        
        /* === レポートボックススタイル === */
        .report-box {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .report-box-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .report-box-header:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b4199 100%);
        }
        
        .report-box-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .report-toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .report-box-content {
            background: white;
            max-height: 600px;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 600px;
            }
        }

        /* === 統計表示 === */
        .stats-display {
            display: block;
        }

        .stats-display.hidden {
            display: none;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin: 0;
        }

        .btn-secondary {
            flex: 1;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .report-action-area {
            padding: 10px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .report-generate-btn {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 12px 24px;
            font-size: 16px;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-advance,
        .btn-previous {
            background: #90EE90;
            color: #2d5a2d;
        }

        .btn-advance:hover,
        .btn-previous:hover {
            background: #7dd87d;
        }


        /* === ボトム入力フォーム === */
        .bottom-input {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px 20px 20px;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .experience-input {
            flex: 1;
        }

        .input-row label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }

        .input-row input,
        .input-row textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-row input:focus,
        .input-row textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row textarea {
            resize: none;
            height: 60px;
            min-height: 60px;
            max-height: 120px;
            padding-right: 60px;
        }

        .submit-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            background: #b39ddb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(179, 157, 219, 0.4);
            z-index: 10;
        }

        .submit-btn svg {
            width: 24px;
            height: 24px;
            transform: rotate(-10deg);
        }

        .submit-btn:hover {
            background: #9575cd;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(179, 157, 219, 0.6);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* === ステータス表示 === */
        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        /* === ローディング === */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* レベルカード特別スタイル */
        .stat-card.level-card {
            margin-left: 10px;
            position: relative;
        }
        
        /* レベルアップ吹き出し */
        .level-up-bubble {
            position: fixed;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            opacity: 0;
            animation: bubbleAnimation 2s ease-out forwards;
            z-index: 10000;
            pointer-events: none;
        }
        
        .level-up-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #764ba2;
        }
        
        @keyframes bubbleAnimation {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }
        }
        
        /* レベルアップ時のアニメーション */
        .stat-card.level-up-animation .stat-number {
            animation: levelUpNumber 2s ease-out;
        }
        
        .stat-card.level-up-animation {
            animation: levelUpCard 2s ease-out;
        }
        
        @keyframes levelUpNumber {
            0% {
                transform: scale(1);
                color: #7e57c2;
            }
            20% {
                transform: scale(1.8);
                color: #ffd700;
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            40% {
                transform: scale(1.6);
            }
            60% {
                transform: scale(1.7);
            }
            80% {
                transform: scale(1.5);
                color: #ffd700;
            }
            100% {
                transform: scale(1);
                color: #7e57c2;
                text-shadow: none;
            }
        }
        
        @keyframes levelUpCard {
            0% {
                background: rgba(179, 157, 219, 0.05);
            }
            20% {
                background: rgba(255, 215, 0, 0.3);
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            }
            80% {
                background: rgba(255, 215, 0, 0.2);
            }
            100% {
                background: rgba(179, 157, 219, 0.05);
                box-shadow: none;
            }
        }
        
        /* EXPバー輝きエフェクト */
        .exp-bar.glowing {
            animation: barGlow 1s ease-in-out;
        }
        
        @keyframes barGlow {
            0% {
                box-shadow: 0 0 5px rgba(179, 157, 219, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(179, 157, 219, 1), 
                            0 0 40px rgba(179, 157, 219, 0.8),
                            0 0 60px rgba(179, 157, 219, 0.6);
                transform: scaleY(1.1);
            }
            100% {
                box-shadow: 0 0 5px rgba(179, 157, 219, 0.5);
                transform: scaleY(1);
            }
        }
        
        /* EXPバーディゾルブエフェクト */
        .exp-bar.dissolving {
            animation: barDissolve 0.8s ease-out forwards;
        }
        
        @keyframes barDissolve {
            0% {
                opacity: 1;
                filter: blur(0px);
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                filter: blur(2px);
                transform: scale(1.05);
            }
            100% {
                opacity: 0;
                filter: blur(10px);
                transform: scale(1.1);
            }
        }

        /* === 編集モード === */
        .edit-mode {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        /* === レーダーチャート === */
        .radar-chart-container {
            width: 100%;
            max-width: 350px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: block !important;
        }
        
        #radarChart {
            max-height: 280px;
            display: block !important;
        }
        
        .radar-chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #7e57c2;
            margin-bottom: 15px;
        }
        
        .radar-legend {
            margin-top: 15px;
            padding: 10px;
            background: rgba(179, 157, 219, 0.05);
            border-radius: 10px;
            font-size: 14px;
        }
        
        .radar-legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .radar-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* === ログインモーダル === */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .login-title {
            text-align: center;
            font-size: 24px;
            color: #7e57c2;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-input {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #b39ddb;
        }
        
        .login-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
        }
        
        .login-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .user-info {
            position: fixed;
            top: 120px;
            right: 20px;
            display: none;
            z-index: 1000;
        }

        .edit-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .edit-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        /* === 空状態表示 === */
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* === レスポンシブ調整 === */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .monitor-tab {
                font-size: 0.7rem;
                padding: 8px 10px;
                min-width: 100px;
            }

            .monitor h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .bottom-input {
                padding: 12px 15px 15px;
            }

            .input-row {
                flex-direction: column;
                gap: 5px;
            }


            .stats-grid {
                gap: 4px;
                margin-bottom: 0;
            }

            .stat-card {
                padding: 3px 6px;
                min-width: 55px;
                max-width: 70px;
            }

            .stat-number {
                font-size: 0.75rem;
                color: #7e57c2;
            }

            .stat-label {
                font-size: 0.6rem;
                color: #aaa;
            }

            .report-actions {
                gap: 6px;
            }

            .record-text {
                font-size: 1.1rem;
                line-height: 1.7;
                letter-spacing: 0.01em;
            }

            .category-item .category-text {
                font-size: 1.05rem;
                line-height: 1.7;
                letter-spacing: 0.01em;
            }

            .monitor-stats {
                padding: 8px 15px 6px;
            }

            .monitor-content {
                padding: 12px 15px;
            }

            .monitor h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .btn-secondary {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        /* === キーボード操作対応 === */
        .input-row textarea {
            transition: height 0.3s ease;
        }

        .input-row textarea:focus {
            height: 80px;
        }
        
        /* === モバイル縦画面最適化 === */
        @media screen and (max-width: 480px) and (orientation: portrait) {
            body {
                padding: 0;
                margin: 0;
                height: 100vh;
                overflow: hidden;
            }
            
            .header {
                padding: 10px;
                position: static; /* 固定位置を解除 */
                width: 100%;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header p {
                font-size: 0.7rem;
            }
            
            .monitor-tabs {
                padding: 5px;
                gap: 3px;
                background: rgba(255,255,255,0.95);
            }
            
            .monitor-tab {
                padding: 6px 14px;
                font-size: 0.7rem;
                min-width: 90px;
                border-radius: 18px;
            }
            
            .container {
                margin-top: 0;
                padding: 10px;
                width: 100%;
                max-width: 100%;
            }
            
            /* LOG画面専用のレイアウト */
            #monitor1 {
                display: flex;
                flex-direction: column;
                height: calc(100vh - 140px); /* ヘッダーとタブを除いた高さ */
            }
            
            #monitor1 .monitor-stats {
                flex-shrink: 0;
                background: white;
                z-index: 10;
            }
            
            #monitor1 .monitor-content {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px;
            }
            
            #monitor1 .input-area {
                display: block !important;
                position: static; /* 通常のフローに戻す */
                background: white;
                padding: 12px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                flex-shrink: 0;
                border-top: 1px solid #e0e0e0;
            }
            
            .monitor {
                width: 100%;
                height: auto;
                max-height: none;
                overflow: visible;
            }
            
            .monitor-content {
                padding-bottom: 20px;
                min-height: 150px;
            }
            
            /* 他の画面用の入力エリア設定（LIST、REPORT画面では非表示） */
            .input-area {
                display: none;
            }
            
            .input-row textarea {
                font-size: 16px; /* iOSのズーム防止 */
            }
            
            .btn-primary {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                margin-top: 8px;
            }
            
            #monitor1 .input-row {
                flex-direction: row; /* 横並びを維持 */
                gap: 8px;
                align-items: stretch;
            }
            
            #monitor1 .experience-input {
                flex: 1;
            }
            
            #monitor1 .input-row textarea {
                height: 50px; /* 固定高さ */
                min-height: 50px;
                max-height: 80px;
            }
            
            .category-element {
                padding: 8px;
                margin: 4px 0;
            }
            
            .element-content {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .element-reason {
                font-size: 12px;
                max-width: 250px;
            }
            
            #radarChart {
                max-width: 100%;
                height: auto !important;
                margin: 0 auto;
            }
            
            .user-info {
                top: 5px;
                right: 5px;
                font-size: 11px;
            }
            
            .user-name-clickable {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .user-info button {
                display: none; /* モバイルではAPIキー設定ボタンを隠す */
            }
            
            /* ステータスメッセージをモバイル対応 */
            .status-bar {
                bottom: 160px; /* 入力エリアの上に配置 */
            }
            
            /* 日付切り替えドロップダウンの最適化 */
            .day-dropdown {
                width: calc(100% - 20px);
                max-width: 300px;
                right: 10px;
            }
        }
        
        /* === タッチデバイス最適化 === */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari対応 */
            .btn-primary, .btn-secondary, .speech-bubble {
                -webkit-tap-highlight-color: transparent;
                cursor: pointer;
            }
            
            .category-element {
                -webkit-user-select: none;
                user-select: none;
            }
        }
        
        /* === みんなの学びフローティングボタン === */
        .shared-learning-floating-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
            z-index: 1000;
        }
        
        .shared-learning-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .shared-learning-floating-btn:active {
            transform: scale(0.95);
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ff4757;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* モバイル対応 */
        @media screen and (max-width: 480px) {
            .shared-learning-floating-btn {
                bottom: 180px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            /* メインコンテンツの高さ調整 */
            .main-content {
                height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
                position: relative;
            }
        }
        
        /* 開発者モード用ゴーストボタンスタイル */
        .ghost-reaction {
            position: relative;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.1) 5px,
                rgba(255, 255, 255, 0.1) 10px
            );
        }

        /* === 個人情報アラート スタイル === */
        .personal-info-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .alert-modal {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
            animation: alertSlideIn 0.3s ease-out;
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 2rem;
        }

        .alert-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .alert-content {
            padding: 25px;
            line-height: 1.6;
        }

        .alert-content ul {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .alert-reason {
            color: #666;
            font-style: italic;
            margin: 15px 0;
        }

        .alert-suggestion {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .alert-actions {
            padding: 0 25px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .alert-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #74b9ff;
            color: white;
        }

        .edit-btn:hover {
            background: #0984e3;
            transform: translateY(-2px);
        }

        .continue-btn {
            background: #00b894;
            color: white;
        }

        .continue-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === ユーザーポップアップ === */
        .user-popup {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            min-width: 220px;
            z-index: 1001;
            display: none;
            animation: popupFadeIn 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-popup::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 24px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid white;
        }

        .user-popup-content {
            padding: 16px 20px;
        }

        .user-popup-content p {
            margin: 0 0 12px 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .user-popup-content p:first-child {
            font-size: 15px;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .user-popup-content .logout-btn {
            background: #fafafa;
            color: #666;
            border: 1px solid #e8e8e8;
            padding: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
            width: 100%;
            text-align: center;
        }

        .user-popup-content .logout-btn:hover {
            background: #fff5f5;
            color: #e74c3c;
            border-color: #ffdddd;
        }

        .user-name-clickable {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #7e57c2;
            font-weight: bold;
            position: relative;
        }

        .user-name-clickable:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- ログインモーダル -->
    <div id="loginModal" class="login-modal" style="display: none;">
        <div class="login-container">
            <div class="login-title">MULTAs ログイン</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="loginId" class="login-input" placeholder="IDネーム" required>
                <input type="password" id="loginPassword" class="login-input" placeholder="パスワード" required>
                <button type="submit" class="login-button">ログイン</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>
    
    <!-- ユーザー情報表示 -->
    <div id="userInfo" class="user-info"></div>
    
    <!-- ヘッダー -->
    <div class="header">
        <h1>MULTAs v2.2 [SAFETY MODE]</h1>
        <p>Medical University Learning and Training Assessment system - 安定版</p>
        <!-- 日付選択 -->
        <div class="day-selector">
            <div class="day-display" onclick="toggleDayDropdown()">
                <span id="currentDayLabel">1日目</span>
                <span style="font-size: 0.7em;">▼</span>
            </div>
            <div class="day-dropdown" id="dayDropdown">
                <div class="day-option dev-only" onclick="selectDay('practice')" style="display: none;">練習</div>
                <div class="day-option selected" onclick="selectDay(1)">1日</div>
                <div class="day-option" onclick="selectDay(2)">2日</div>
                <div class="day-option" onclick="selectDay(3)">3日</div>
                <div class="day-option" onclick="selectDay(4)">4日</div>
                <div class="day-option" onclick="selectDay(5)">5日</div>
            </div>
        </div>
    </div>

    <!-- モニター切り替えタブ -->
    <div class="monitor-tabs">
        <button class="monitor-tab active" onclick="switchMonitor('monitor1')">
            LOG
        </button>
        <button class="monitor-tab" onclick="switchMonitor('monitor2')">
            LIST
        </button>
        <button class="monitor-tab" onclick="switchMonitor('monitor3')">
            REPORT
        </button>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content">
        
        <!-- 統計固定エリア -->
        <div class="monitor-stats">
            <!-- モニター1用統計 -->
            <div id="stats-monitor1" class="stats-display">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordCount">0</div>
                        <div class="stat-label">記録回数</div>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar" style="width: 0%;"></div>
                    </div>
                    <div class="stat-card level-card">
                        <div class="stat-number" id="userLevel">1</div>
                        <div class="stat-label">LV</div>
                    </div>
                </div>
            </div>

            <!-- モニター2用統計 -->
            <div id="stats-monitor2" class="stats-display" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordCount2">0</div>
                        <div class="stat-label">記録回数</div>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar2" style="width: 0%;"></div>
                    </div>
                    <div class="stat-card level-card">
                        <div class="stat-number" id="userLevel2">1</div>
                        <div class="stat-label">LV</div>
                    </div>
                </div>
            </div>

            <!-- モニター3用統計 -->
            <div id="stats-monitor3" class="stats-display" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordCount3">0</div>
                        <div class="stat-label">記録回数</div>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar3" style="width: 0%;"></div>
                    </div>
                    <div class="stat-card level-card">
                        <div class="stat-number" id="userLevel3">1</div>
                        <div class="stat-label">LV</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- モニター1: ログ保存 -->
        <div id="monitor1" class="monitor active">
            <div class="monitor-content">
                <div id="recordsList">
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <p>まだ記録がありません<br>下のフォームから最初の記録を追加してください</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- モニター2: 体験整理 -->
        <div id="monitor2" class="monitor">
            <div class="monitor-content">
                <div id="organizedView">
                    <div class="empty-state">
                        <div class="icon">🤖</div>
                        <p>記録を追加すると<br>AI分析による12時計分類が表示されます</p>
                    </div>
                </div>
                <!-- みんなの学びボタン（LIST内配置） -->
                <div id="sharedLearningBtnArea" class="dev-only" style="text-align: center; margin-top: 30px; padding: 20px 0; display: none;">
                    <button class="shared-learning-btn" onclick="toggleSharedLearning()" style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(254, 202, 87, 0.3) 100%); border: 2px dashed rgba(255, 107, 107, 0.5); padding: 15px 30px; border-radius: 30px; color: rgba(255, 255, 255, 0.8); font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; opacity: 0.7;" title="開発モード: ローカルデモ機能">
                        <span style="font-size: 24px; position: relative; opacity: 0.6;">
                            <span style="position: absolute; left: -8px; top: -5px; opacity: 0.5;">💬</span>
                            <span style="position: absolute; left: 5px; top: -8px; opacity: 0.6;">💬</span>
                            <span style="position: relative;">💬</span>
                        </span>
                        <span style="font-size: 16px;">みんなの学び <span style="font-size: 0.8em; opacity: 0.7;">(Demo)</span></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- モニター3: Dailyレポート -->
        <div id="monitor3" class="monitor">
            <div class="monitor-content">
                <!-- レーダーチャート表示エリア -->
                <div id="radarChartContainer" class="radar-chart-container">
                    <div class="radar-chart-title">12時計分類 体験チャート</div>
                    <canvas id="radarChart"></canvas>
                    <div class="radar-legend" id="radarLegend"></div>
                </div>
                <!-- レポート表示エリア -->
                <div id="dailyReport">
                    <div class="report-content">
                        <h4>📋 本日の実習レポート</h4>
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>記録を追加してから<br>「レポート生成」ボタンを押すと<br>その日の体験をまとめたレポートが自動生成されます</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- モニター4: みんなの学び -->
        <div id="monitor4" class="monitor">
            <div class="monitor-stats" id="stats-monitor4" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="sharedCount">0</div>
                        <div class="stat-label">共有された学び</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="likeCount">0</div>
                        <div class="stat-label">いいね獲得数</div>
                    </div>
                </div>
            </div>
            <div class="monitor-content">
                <div id="sharedLearning">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #7e57c2; margin: 0;">
                            🌟 みんなの学び
                            ${isDeveloperMode ? '<span style="font-size: 0.7em; color: #999; font-weight: normal;">(ローカルデモ)</span>' : ''}
                        </h3>
                        <button onclick="backToList()" style="background: #7e57c2; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer;">
                            ← LISTに戻る
                        </button>
                    </div>
                    <div class="shared-learning-content" id="sharedLearningContent">
                        <!-- 共有された学びがここに表示される -->
                        <div class="empty-state">
                            <div class="icon">🤝</div>
                            <p>他の実習生の学びがここに表示されます<br>あなたの記録も匿名で共有できます</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ボトム入力フォーム -->
    <div class="bottom-input">
        <!-- レポート生成ボタン（REPORT画面の時のみ表示） -->
        <div id="reportActionArea" class="report-action-area" style="display: none;">
            <button class="btn-secondary report-generate-btn" onclick="generateDailyReport()">
                🤖 レポート生成
            </button>
            <button class="btn-primary summary-report-btn" onclick="generateSummaryReport()" style="margin-top: 10px;">
                📊 総合レポート生成
            </button>
            <!-- 開発用：サンプル投稿ボタン -->
            <button class="btn-secondary sample-btn dev-only" onclick="addSampleRecords()" style="margin-top: 10px; background: #6c757d; display: none;">
                🔧 サンプル10投稿を追加（開発用）
            </button>
            <button class="btn-secondary sample-btn dev-only" onclick="addLongSampleRecord()" style="margin-top: 10px; background: #495057; display: none;">
                📝 長文サンプル投稿を追加（開発用）
            </button>
        </div>
        
        <div class="input-row">
            <div class="experience-input" style="position: relative;">
                <textarea id="experienceText" placeholder="実習で体験したことを記録… ※患者の個人情報は入力しない"></textarea>
                <button type="button" class="submit-btn" onclick="submitExperience()" title="送信">
                    <span id="submitText">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white"/>
                        </svg>
                    </span>
                    <span id="submitLoading" style="display: none;">
                        <span class="loading"></span>
                    </span>
                </button>
            </div>
        </div>

        <div id="statusMessage"></div>
    </div>

    <script>
        // === グローバル変数 ===
        let records = [];
        let recordIdCounter = 0;
        let currentMonitor = 'monitor1';
        let currentDay = 1;  // 現在の日付（1-5またはpractice）
        
        // === DOM要素キャッシュ ===
        const DOM = {};
        function initDOMCache() {
            // 頻繁に使用される要素をキャッシュ
            DOM.expBar = [
                document.getElementById('expBar'),
                document.getElementById('expBar2'),
                document.getElementById('expBar3')
            ];
            DOM.expText = [
                document.getElementById('expText'),
                document.getElementById('expText2'),
                document.getElementById('expText3')
            ];
            DOM.userLevel = [
                document.getElementById('userLevel'),
                document.getElementById('userLevel2'),
                document.getElementById('userLevel3')
            ];
            DOM.recordCount = [
                document.getElementById('recordCount'),
                document.getElementById('recordCount2'),
                document.getElementById('recordCount3')
            ];
            DOM.recordsList = document.getElementById('recordsList');
            DOM.organizedView = document.getElementById('organizedView');
            DOM.radarChartCanvas = document.getElementById('radarChart');
            DOM.dailyReport = document.getElementById('dailyReport');
            DOM.currentDayLabel = document.getElementById('currentDayLabel');
            DOM.messageInput = document.getElementById('messageInput');
        }
        
        // === OpenAI API設定 ===
        // APIキー管理方法の選択
        const USE_PROXY = false; // プロキシサービスを使用する場合はtrue
        const PROXY_URL = ''; // 独自のプロキシサーバーURL（例: Vercel Functions）
        
        let OPENAI_API_KEY = localStorage.getItem('multasApiKey') || '';
        
        // APIキーが未設定の場合の処理
        function checkApiKey() {
            if (!USE_PROXY && !OPENAI_API_KEY) {
                const message = `OpenAI APIキーを入力してください:

【セキュリティに関する重要な注意】
━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 各ユーザーは自分のAPIキーを使用してください
⚠️ 他人のAPIキーを使用しないでください
⚠️ 自分のAPIキーを他人と共有しないでください
━━━━━━━━━━━━━━━━━━━━━━━━━━━

📍 APIキーの取得方法:
1. https://platform.openai.com にアクセス
2. API keysページで新しいキーを作成
3. 使用量上限を設定することを推奨

✅ このキーはあなたのブラウザにのみ保存されます
✅ サーバーには送信されません
✅ 一度入力すれば次回から自動的に使用されます`;
                
                const key = prompt(message);
                if (key) {
                    OPENAI_API_KEY = key;
                    localStorage.setItem('multasApiKey', key);
                    showStatus('APIキーを保存しました（ブラウザ内のみ）', 'success');
                } else {
                    alert('APIキーが設定されていないため、AI分類機能は使用できません。');
                    return false;
                }
            }
            return true;
        }
        
        // === 医学実習12時計分類システム ===
        const CLOCK_CATEGORIES = {
            0: { name: '分類不能', icon: '❓', vector: {x: 0, y: 0} },
            1: { name: '医療倫理', icon: '⚖️', vector: {x: -0.3, y: -0.5} },
            2: { name: '地域医療', icon: '🏘️', vector: {x: -0.5, y: 0.8} },
            3: { name: '医学知識', icon: '📚', vector: {x: 0.8, y: -0.5} },
            4: { name: '診察・手技', icon: '🩺', vector: {x: 0.9, y: -0.7} },
            5: { name: '患者に対する問題解決能力', icon: '🤝', vector: {x: 0.5, y: -0.9} },
            6: { name: '統合的臨床', icon: '🏥', vector: {x: 0, y: -0.8} },
            7: { name: '多職種連携', icon: '👥', vector: {x: -0.5, y: -0.7} },
            8: { name: 'コミュニケーション', icon: '💬', vector: {x: -0.8, y: -0.3} },
            9: { name: '一般教養', icon: '📖', vector: {x: -0.9, y: 0.3} },
            10: { name: '保健・福祉', icon: '🏛️', vector: {x: -0.3, y: 0.9} },
            11: { name: '行政', icon: '🏥', vector: {x: -0.7, y: 0.7} },
            12: { name: '社会医学/公衆衛生', icon: '🌍', vector: {x: 0, y: 0.9} }
        };
        let userLevel = 1;
        let userExp = 0;
        let totalPosts = 0; // 総投稿数を追跡
        let generatedReports = {}; // 生成済みレポートを追跡
        let savedReports = {}; // 日付別の生成済みレポートHTML
        let categoryPointsByDay = {}; // 日付別カテゴリポイント
        let summaryReportHtml = null; // 総合レポートのHTMLを保存
        let currentUser = null; // ログインユーザー情報
        let isDeveloperMode = false; // 開発者モードフラグ
        
        // 各日付のカテゴリポイントを初期化
        const dayKeys = ['practice', '1', '2', '3', '4', '5'];
        dayKeys.forEach(day => {
            categoryPointsByDay[day] = {};
            for (let i = 0; i <= 12; i++) {
                categoryPointsByDay[day][i] = 0;
            }
        });
        
        // ローカルストレージから読み込み
        const savedGameData = localStorage.getItem('multasGameData');
        if (savedGameData) {
            const gameData = JSON.parse(savedGameData);
            userLevel = gameData.userLevel || 1;
            userExp = gameData.userExp || 0;
            totalPosts = gameData.totalPosts || 0;
            generatedReports = gameData.generatedReports || {};
            categoryPointsByDay = gameData.categoryPointsByDay || categoryPointsByDay;
        }

        // === 12時計カテゴリの色定義 ===
        const AI_CATEGORIES = {
            0: { name: '❓ 分類不能', color: '#b2bec3' },
            1: { name: '⚖️ 医療倫理', color: '#ff9ff3' },
            2: { name: '🏘️ 地域医療', color: '#ff6b6b' },
            3: { name: '📚 医学知識', color: '#54a0ff' },
            4: { name: '🩺 診察・手技', color: '#48dbfb' },
            5: { name: '🤝 患者に対する問題解決能力', color: '#1dd1a1' },
            6: { name: '🏥 統合的臨床', color: '#10ac84' },
            7: { name: '👥 多職種連携', color: '#feca57' },
            8: { name: '💬 コミュニケーション', color: '#ff9ff3' },
            9: { name: '📖 一般教養', color: '#dfe6e9' },
            10: { name: '🏛️ 保健・福祉', color: '#6c5ce7' },
            11: { name: '🏥 行政', color: '#a29bfe' },
            12: { name: '🌍 社会医学/公衆衛生', color: '#fd79a8' }
        };

        // === 体験記録送信 ===
        async function submitExperience() {
            const experienceText = document.getElementById('experienceText').value.trim();
            
            if (!experienceText) {
                showStatus('体験内容を入力してください。', 'error');
                return;
            }

            // 個人情報チェック実行
            showLoadingIndicator('個人情報をチェック中...');
            
            try {
                const checkResult = await checkPersonalInformation(experienceText);
                hideLoadingIndicator();
                
                if (checkResult.hasPersonalInfo) {
                    // 個人情報が検出されても続行（ポップアップは表示しない）
                    console.log('個人情報が検出されましたが、処理を続行します:', checkResult);
                }
            } catch (error) {
                hideLoadingIndicator();
                console.error('個人情報チェックでエラー:', error);
                // エラー時は通常処理を続行
            }

            // UI状態を処理中に変更
            const submitBtn = document.querySelector('.submit-btn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';

            try {
                // AI分類を実行
                showStatus('🤖 AI分析中...', 'info');
                const aiResult = await classifyWithAI(experienceText);
                
                // ローカル処理で即座に表示
                const localRecord = {
                    id: ++recordIdCounter,
                    originalText: experienceText,
                    timestamp: new Date(),
                    day: currentDay, // 現在の日付を記録
                    category: aiResult.category,
                    confidence: aiResult.confidence,
                    aiProcessed: true,
                    aiReason: aiResult.reason,
                    depth: aiResult.depth,
                    vector: aiResult.vector,
                    consistency: aiResult.consistency
                };

                records.unshift(localRecord);
                
                // 長文判定（150文字以上）
                if (experienceText.length >= 150) {
                    // 要素分解を実行
                    const multiResult = await classifyWithMultipleElements(experienceText);
                    if (multiResult && multiResult.elements) {
                        const dayKey = String(currentDay);
                        if (!categoryPointsByDay[dayKey]) {
                            categoryPointsByDay[dayKey] = {};
                            for (let i = 0; i <= 12; i++) {
                                categoryPointsByDay[dayKey][i] = 0;
                            }
                        }
                        
                        // 各要素に対してポイントを加算（1pt未満は1ptとみなす）
                        let totalWeight = 0;
                        multiResult.elements.forEach(element => {
                            const points = Math.max(1, Math.round(element.weight));
                            categoryPointsByDay[dayKey][element.category] = 
                                (categoryPointsByDay[dayKey][element.category] || 0) + points;
                            totalWeight += points;
                        });
                        
                        // 要素分解結果を記録に保存
                        localRecord.multipleElements = multiResult.elements;
                        localRecord.totalWeight = totalWeight;
                        
                        // 複数要素の場合、Expをボーナス
                        if (multiResult.elements.length > 1 && currentDay !== 'practice' && aiResult.category !== 0) {
                            const expPerPost = Math.ceil(100 / userLevel);
                            const bonusExp = Math.floor(expPerPost * 0.5 * (multiResult.elements.length - 1));
                            userExp += bonusExp;
                            showStatus(`🌟 複数要素ボーナス +${bonusExp}Exp`, 'success');
                        }
                    }
                } else {
                    // 短文の場合は単一分類
                    const dayKey = String(currentDay);
                    if (!categoryPointsByDay[dayKey]) {
                        categoryPointsByDay[dayKey] = {};
                        for (let i = 0; i <= 12; i++) {
                            categoryPointsByDay[dayKey][i] = 0;
                        }
                    }
                    categoryPointsByDay[dayKey][aiResult.category] = (categoryPointsByDay[dayKey][aiResult.category] || 0) + 1;
                }
                
                saveGameData();
                
                // 練習用以外かつ分類不能（カテゴリ0）以外の場合のみ経験値を追加
                if (currentDay !== 'practice' && aiResult.category !== 0) {
                    addExperience();
                } else if (currentDay !== 'practice' && aiResult.category === 0) {
                    showStatus('❓ 分類不能のため経験値は獲得できません', 'info');
                }
                
                updateAllViews();
                showStatus('✅ 送信しました！', 'success');

                // バックグラウンドでGAS処理
                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'processExperience',
                            studentName: studentName,
                            experienceText: experienceText
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // GAS処理成功時にローカル記録を更新
                            localRecord.category = result.classificationResult.category;
                            localRecord.confidence = result.classificationResult.confidence;
                            localRecord.aiProcessed = result.classificationResult.aiProcessed;
                            updateAllViews();
                            showStatus('🤖 AI分析完了！分類結果を更新しました。', 'success');
                        }
                    }
                } catch (gasError) {
                    console.log('GAS処理はスキップ（ローカル動作）:', gasError);
                }

            } catch (error) {
                // ローカル環境では正常動作なのでエラー表示しない
                console.log('ローカル環境での動作:', error);
            } finally {
                // UI状態を元に戻す
                submitBtn.disabled = false;
                submitText.style.display = 'inline-block';
                submitLoading.style.display = 'none';
                
                // フォームをクリア
                document.getElementById('experienceText').value = '';
            }
        }

        // === モニター切り替え ===
        function switchMonitor(monitorId) {
            // 全モニターを非表示
            document.querySelectorAll('.monitor').forEach(monitor => {
                monitor.classList.remove('active');
            });

            // 全タブの active クラスを削除
            document.querySelectorAll('.monitor-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 全統計表示を非表示
            document.querySelectorAll('.stats-display').forEach(stats => {
                stats.style.display = 'none';
            });

            // 選択されたモニターを表示
            document.getElementById(monitorId).classList.add('active');
            event.target.classList.add('active');

            // 対応する統計を表示
            const statsId = 'stats-' + monitorId;
            const statsElement = document.getElementById(statsId);
            if (statsElement) {
                statsElement.style.display = 'block';
            }
            
            // レポート生成ボタンの表示制御
            const reportActionArea = document.getElementById('reportActionArea');
            if (monitorId === 'monitor3') {
                reportActionArea.style.display = 'block';
                // レーダーチャートを更新
                updateRadarChart();
                // 保存されたレポートを表示
                displayAllReports();
            } else {
                reportActionArea.style.display = 'none';
            }

            currentMonitor = monitorId;
            
            // みんなの学び画面の場合
            if (monitorId === 'monitor4') {
                loadSharedLearnings();
            }

            // モニター切り替え時に表示を更新
            updateAllViews();
        }

        // === 全ビュー更新 ===
        // === 経験値追加 ===
        async function addExperience() {
            totalPosts++;
            
            // 現在のレベルで獲得するExp = 100 / レベル（切り上げ）
            const expPerPost = Math.ceil(100 / userLevel);
            const oldExp = userExp;
            userExp += expPerPost;
            
            // レベル1の場合は特別な演出
            if (userLevel === 1) {
                await animateExpGain(oldExp, userExp);
            } else {
                // 通常の即座更新
                updateExpDisplay();
            }
            
            // レベルアップチェック（100Expでレベルアップ）
            if (userExp >= 100) {
                // まず100%まで表示を更新
                const expBars = [
                    document.getElementById('expBar'),
                    document.getElementById('expBar2'),
                    document.getElementById('expBar3')
                ];
                const expTexts = [
                    document.getElementById('expText'),
                    document.getElementById('expText2'),
                    document.getElementById('expText3')
                ];
                
                expBars.forEach(bar => {
                    if (bar) bar.style.width = '100%';
                });
                expTexts.forEach(text => {
                    if (text) text.textContent = 'EXP: 100 / 100';
                });
                
                // 100%になったことを見せる
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (userLevel === 1) {
                    // レベル1→2の特別演出
                    await showExpBarGlow();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // レベルアップ処理
                const overflowExp = userExp - 100;  // 100を超えた分を記憶
                userLevel++;
                showLevelUpAnimation();
                
                // ディゾルブ演出
                await dissolveExpBar();
                
                // 余剰分を繰り越し
                userExp = overflowExp;
                updateExpDisplay(); // 新しいレベルとEXPを表示
            }
            
            // データを保存
            saveGameData();
            
            // レベル1以外の場合の最終更新
            if (userLevel !== 1) {
                updateExpDisplay();
            }
        }
        
        // === EXPゲインアニメーション（レベル1専用） ===
        async function animateExpGain(startExp, endExp) {
            const duration = 1500; // 1.5秒かけてゆっくり
            const steps = 30;
            const stepDuration = duration / steps;
            const expIncrement = (endExp - startExp) / steps;
            
            for (let i = 0; i <= steps; i++) {
                const currentExp = Math.min(startExp + (expIncrement * i), endExp);
                userExp = Math.round(currentExp);
                updateExpDisplay();
                await new Promise(resolve => setTimeout(resolve, stepDuration));
            }
            
            userExp = endExp; // 最終値を確実に設定
            updateExpDisplay();
        }
        
        // === EXPバーの輝きエフェクト ===
        async function showExpBarGlow() {
            const expBars = [
                document.getElementById('expBar'),
                document.getElementById('expBar2'),
                document.getElementById('expBar3')
            ];
            
            expBars.forEach(bar => bar.classList.add('glowing'));
            
            // アニメーション終了後にクラスを削除
            await new Promise(resolve => setTimeout(resolve, 1000));
            expBars.forEach(bar => bar.classList.remove('glowing'));
        }
        
        // === EXPバーディゾルブエフェクト ===
        async function dissolveExpBar() {
            const expBars = [
                document.getElementById('expBar'),
                document.getElementById('expBar2'),
                document.getElementById('expBar3')
            ];
            
            // ディゾルブアニメーション開始
            expBars.forEach(bar => {
                bar.classList.add('dissolving');
            });
            
            // アニメーション完了を待つ
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // クラスを削除してリセット
            expBars.forEach(bar => {
                bar.classList.remove('dissolving');
                bar.style.opacity = '1';
                bar.style.filter = 'none';
                bar.style.transform = 'none';
            });
        }
        
        // === EXPバーを即座に設定（アニメーションなし） ===
        function setExpBarInstant(percent) {
            const expBars = [
                document.getElementById('expBar'),
                document.getElementById('expBar2'),
                document.getElementById('expBar3')
            ];
            
            // トランジションを一時的に無効化
            expBars.forEach(bar => {
                bar.style.transition = 'none';
                bar.style.width = percent + '%';
            });
            
            // 次のフレームでトランジションを復活
            requestAnimationFrame(() => {
                expBars.forEach(bar => {
                    bar.style.transition = 'width 0.3s ease-out';
                });
            });
        }
        
        // === レベルアップアニメーション表示 ===
        function showLevelUpAnimation() {
            // すべてのレベルカードを取得
            const levelCards = document.querySelectorAll('.stat-card.level-card');
            
            levelCards.forEach(card => {
                // アニメーションクラスを追加
                card.classList.add('level-up-animation');
                
                // 吹き出しを作成
                const bubble = document.createElement('div');
                bubble.className = 'level-up-bubble';
                bubble.textContent = 'LEVEL UP!';
                document.body.appendChild(bubble);
                
                // カードの位置を取得
                const rect = card.getBoundingClientRect();
                const bubbleHeight = 40; // 吹き出しの推定高さ
                
                // 吹き出しの位置を設定
                bubble.style.left = rect.left + (rect.width / 2) + 'px';
                bubble.style.top = (rect.top - bubbleHeight - 20) + 'px';
                bubble.style.transform = 'translateX(-50%)';
                
                // アニメーション終了後にクラスと吹き出しを削除
                setTimeout(() => {
                    card.classList.remove('level-up-animation');
                    bubble.remove();
                }, 2000);
            });
            
            // ステータスメッセージも表示
            showStatus(`🎉 LEVEL UP! LV.${userLevel}になりました！`, 'success');
        }
        
        // === ボーナスレベル追加（アニメーション付き） ===
        async function addBonusLevels(levels, message) {
            showStatus(`🎁 ${message}`, 'success');
            
            for (let i = 0; i < levels; i++) {
                // 現在のEXPから100%までアニメーション
                const currentPercent = userExp;
                const animationDuration = 800; // 0.8秒で100%まで
                const startTime = Date.now();
                
                // EXPバーを100%までアニメーション
                await new Promise(resolve => {
                    const expBars = [
                        document.getElementById('expBar'),
                        document.getElementById('expBar2'),
                        document.getElementById('expBar3')
                    ];
                    const expTexts = [
                        document.getElementById('expText'),
                        document.getElementById('expText2'),
                        document.getElementById('expText3')
                    ];
                    
                    const animate = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / animationDuration, 1);
                        
                        // イージング関数（ease-out）
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        const newPercent = currentPercent + (100 - currentPercent) * easeOut;
                        
                        // EXPバーを更新
                        expBars.forEach(bar => {
                            if (bar) bar.style.width = newPercent + '%';
                        });
                        expTexts.forEach(text => {
                            if (text) text.textContent = `EXP: ${Math.floor(newPercent)} / 100`;
                        });
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            // 100%に達したことを確実にする
                            expBars.forEach(bar => {
                                if (bar) bar.style.width = '100%';
                            });
                            expTexts.forEach(text => {
                                if (text) text.textContent = 'EXP: 100 / 100';
                            });
                            resolve();
                        }
                    };
                    animate();
                });
                
                // 100%で少し待機（満タンを見せる）
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // レベルアップ
                userLevel++;
                userExp = 0;
                
                // レベルアップアニメーション
                showLevelUpAnimation();
                
                // EXPバーを0にリセット（ディゾルブ演出）
                await dissolveExpBar();
                
                // 表示更新
                updateExpDisplay();
                saveGameData();
                
                // 次のアニメーションまで待機
                await new Promise(resolve => setTimeout(resolve, 800));
            }
        }
        
        // === EXPバーアニメーション ===
        async function animateExpBar() {
            const expBar = document.getElementById('expBar');
            const expBar2 = document.getElementById('expBar2');
            const expBar3 = document.getElementById('expBar3');
            
            // 現在の幅から100%までアニメーション
            const currentWidth = (userExp / 100) * 100;
            const duration = 500; // 0.5秒でアニメーション
            const steps = 20;
            const stepDuration = duration / steps;
            const widthIncrement = (100 - currentWidth) / steps;
            
            for (let i = 0; i < steps; i++) {
                const newWidth = currentWidth + (widthIncrement * (i + 1));
                expBar.style.width = newWidth + '%';
                expBar2.style.width = newWidth + '%';
                expBar3.style.width = newWidth + '%';
                await new Promise(resolve => setTimeout(resolve, stepDuration));
            }
            
            // 最後に確実に100%にする
            expBar.style.width = '100%';
            expBar2.style.width = '100%';
            expBar3.style.width = '100%';
        }
        
        // === ゲームデータ保存 ===
        function saveGameData() {
            const gameData = {
                userLevel: userLevel,
                userExp: userExp,
                totalPosts: totalPosts,
                generatedReports: generatedReports,
                categoryPointsByDay: categoryPointsByDay
            };
            localStorage.setItem('multasGameData', JSON.stringify(gameData));
        }

        // === 長文要素分解AI分類関数 ===
        async function classifyWithMultipleElements(recordText) {
            // APIキーチェック
            checkApiKey();
            if (!OPENAI_API_KEY) {
                throw new Error('APIキーが設定されていません');
            }
            
            try {
                const prompt = `医学生の実習記録を文章単位で分解し、各要素の学習内容を12時計分類で詳細に分類してください。

記録: "${recordText}"

【分析方法】
1. 文章を意味のある単位（文や節）に分解する
2. 各単位で学んだ内容を特定する
3. 複数のスキルが統合されている場合は「統合的臨床」として分類
4. 単一のスキルの場合は該当するカテゴリに分類

【12時計カテゴリ】
0時: 分類不能
1時: 医療倫理（倫理、法律、規範、インフォームドコンセント）
2時: 地域医療（訪問診療、在宅医療、地域特性）
3時: 医学知識（疾患、症候、薬理、評価尺度、治療法の理論）
4時: 診察・手技（問診、身体診察、検査手技、情報収集）
5時: 患者に対する問題解決能力（アセスメント、治療方針決定、系統的アプローチ）
6時: 統合的臨床（臨床に関する複数の他分類要素を含み、統合的に考察されている内容）
7時: 多職種連携（チーム医療、院内連携）
8時: コミュニケーション（傾聴、共感、説明、信頼関係構築）
9時: 一般教養（医学以外の知識）
10時: 保健・福祉（社会的サポート、福祉制度、介護）
11時: 行政（病院間連携、紹介）
12時: 社会医学/公衆衛生（病院外の事項に関する複数の他分類要素を含み、統合的に考察されている内容）

【分類例】
- 「患者への説明」だけ → コミュニケーション（8時）
- 「HAM-Dの使用」→ 医学知識（3時）
- 「系統的な問診方法」→ 問題解決能力（5時）
- 「薬の知識を患者にわかりやすく説明し、傾聴しながら信頼関係を構築」→ 統合的臨床（6時）
- 「地域の福祉制度と医療連携を踏まえた退院支援」→ 社会医学/公衆衛生（12時）

【重要】
- 統合的臨床（6時）：臨床場面で複数カテゴリの要素が統合されている場合のみ
- 社会医学/公衆衛生（12時）：病院外・地域に関する複数要素が統合されている場合のみ
- 単一要素の記述は該当する個別カテゴリに分類

以下のJSON形式で回答してください。必ずJSON形式で返答することが重要です:
{
  "elements": [
    {
      "content": "要素の内容（どの部分から抽出したか明記）",
      "category": 数値(0-12),
      "weight": 数値(0.1-1.0),
      "reason": "分類理由"
    }
  ],
  "primary_category": 数値(0-12),
  "total_elements": 要素数
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.3,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                return result;
            } catch (error) {
                console.error('要素分解エラー:', error);
                return null;
            }
        }
        
        // === 個人情報チェック機能 ===
        const PERSONAL_INFO_CHECK_PROMPT = `以下の医学実習記録テキストに、患者を特定できる個人情報が含まれているかチェックしてください。

【検出対象 - 警告が必要】
- フルネーム（田中太郎、佐藤花子、山田一郎など）
- 生年月日（1980年3月15日、昭和55年生まれなど）
- 住所の詳細（東京都新宿区○○町1-2-3など）
- 電話番号（090-1234-5678など）

【許容対象 - 警告不要】
- 年齢・性別（75歳男性、60代女性など）
- イニシャル（A.Kさん、T.S様など）
- 医学用語の固有名詞（川崎病、菊池病、Johnson分類、Crohn病、Parkinson病など）
- 症状や所見の記述
- 病院内の場所（3階病棟、外来など）

テキスト: "{{INPUT_TEXT}}"

以下のJSON形式で回答してください：
{
  "hasPersonalInfo": true/false,
  "detectedItems": ["検出された項目1", "検出された項目2"],
  "reason": "検出理由の説明",
  "suggestion": "修正提案（あれば）"
}`;

        /**
         * 個人情報チェック
         */
        async function checkPersonalInformation(inputText) {
            try {
                // OpenAI APIでチェック
                const prompt = PERSONAL_INFO_CHECK_PROMPT.replace('{{INPUT_TEXT}}', inputText);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'あなたは医学教育における個人情報保護の専門家です。実習記録から患者を特定できる情報を正確に検出してください。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 500
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                return {
                    success: true,
                    ...result
                };
                
            } catch (error) {
                console.error('個人情報チェックエラー:', error);
                // フォールバック：基本的なルールベースチェック
                return performBasicPersonalInfoCheck(inputText);
            }
        }

        /**
         * フォールバック：基本的なルールベースチェック
         */
        function performBasicPersonalInfoCheck(inputText) {
            const detectedItems = [];
            
            // 生年月日パターン
            const datePatterns = [
                /\d{4}年\d{1,2}月\d{1,2}日/g,
                /昭和\d{1,2}年/g,
                /平成\d{1,2}年/g,
                /\d{4}\/\d{1,2}\/\d{1,2}/g
            ];
            
            datePatterns.forEach(pattern => {
                if (pattern.test(inputText)) {
                    detectedItems.push('生年月日の可能性');
                }
            });
            
            // フルネームの可能性（苗字+名前の組み合わせ）
            const namePattern = /[一-龯]{1,4}[一-龯]{1,4}[さん|様|氏|君]/g;
            if (namePattern.test(inputText)) {
                detectedItems.push('フルネームの可能性');
            }
            
            return {
                success: true,
                hasPersonalInfo: detectedItems.length > 0,
                detectedItems: detectedItems,
                reason: detectedItems.length > 0 ? 'ルールベース検出' : '問題なし',
                suggestion: detectedItems.length > 0 ? '年齢・性別での記述をお勧めします' : ''
            };
        }

        /**
         * アラート表示機能
         */
        function showPersonalInfoAlert(checkResult) {
            return new Promise((resolve) => {
                // アラートHTML生成
                const alertHTML = `
                    <div id="personalInfoAlert" class="personal-info-alert">
                        <div class="alert-overlay"></div>
                        <div class="alert-modal">
                            <div class="alert-header">
                                <span class="alert-icon">🚨</span>
                                <h3>個人情報チェック</h3>
                            </div>
                            <div class="alert-content">
                                <p><strong>以下の内容が検出されました：</strong></p>
                                <ul>
                                    ${checkResult.detectedItems.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <p class="alert-reason">${checkResult.reason}</p>
                                ${checkResult.suggestion ? `
                                    <div class="alert-suggestion">
                                        <strong>📝 修正提案：</strong><br>
                                        ${checkResult.suggestion}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="alert-actions">
                                <button id="editButton" class="alert-btn edit-btn">✏️ 修正する</button>
                                <button id="continueButton" class="alert-btn continue-btn">➡️ このまま続行</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // アラートをDOMに追加
                document.body.insertAdjacentHTML('beforeend', alertHTML);
                
                // イベントリスナー設定
                document.getElementById('editButton').addEventListener('click', () => {
                    removeAlert();
                    resolve(false); // 修正を選択
                });
                
                document.getElementById('continueButton').addEventListener('click', () => {
                    removeAlert();
                    resolve(true); // 続行を選択
                });
                
                // オーバーレイクリックで閉じる
                document.querySelector('.alert-overlay').addEventListener('click', () => {
                    removeAlert();
                    resolve(false);
                });
            });
        }

        /**
         * アラート削除
         */
        function removeAlert() {
            const alert = document.getElementById('personalInfoAlert');
            if (alert) {
                alert.remove();
            }
        }

        /**
         * ローディングインジケーター表示
         */
        function showLoadingIndicator(message) {
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.className = 'loading-indicator';
            indicator.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${message}</span>
            `;
            document.body.appendChild(indicator);
        }

        /**
         * ローディングインジケーター非表示
         */
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // === 12時計AI分類関数（単一分類） ===
        async function classifyWithAI(recordText) {
            // APIキーチェック
            checkApiKey();
            if (!OPENAI_API_KEY) {
                throw new Error('APIキーが設定されていません');
            }
            
            try {
                const prompt = `医学生の実習記録を2つの独立した方法で分析してください。

記録: "${recordText}"

【タスク1: 12時計分類】
以下の13カテゴリから最も適切なものを1つ選んでください：

0時: 分類不能（医学実習との関連が不明確、意図が読み取れない）
1時: 医療倫理（倫理、法律、規範）
2時: 地域医療（訪問診療、在宅医療、地域特性）
3時: 医学知識（疾患、症候、基礎医学）
4時: 診察・手技（診察スキル、検査手技）
5時: 患者に対する問題解決能力（個別対応、治療方針決定）
6時: 統合的臨床（臨床能力の統合）
7時: 多職種連携（チーム医療、院内連携）
8時: コミュニケーション（対人能力）
9時: 一般教養（医学以外の知識）
10時: 保健・福祉（介護、保健事業）
11時: 行政（病院間連携、紹介）
12時: 社会医学/公衆衛生（社会医学の統合）

※「空が青かった」のような記録で医学実習との関連が不明な場合は0時を選択

【タスク2: 深度とベクトル座標】
以下を独立して判定してください：

深度（0-4）:
0: 知らない
1: 知っている（名称レベル）
2: 理解している（背景・因果関係）
3: 説明できる（再現性は低い）
4: 定着している（統合的レベル）

座標:
x軸（-1.0〜1.0）: -1=non-technical skill ← → +1=technical skill
y軸（-1.0〜1.0）: -1=臨床（ベッドサイド） ← → +1=地域・社会

以下のJSON形式で回答してください。JSONオブジェクトとして正確に回答することが必要です:
{
  "clock_category": 数値(0-12),
  "clock_reason": "分類理由",
  "depth": 数値(0-4),
  "depth_reason": "深度判定理由",
  "vector": {
    "x": 数値(-1.0〜1.0),
    "y": 数値(-1.0〜1.0)
  },
  "vector_reason": "座標判定理由"
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.3,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API詳細エラー:', errorData);
                    throw new Error(`API request failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                // 整合性チェック
                let consistency_score = 100;
                if (result.clock_category === 0) {
                    // 分類不能の場合は整合性チェックをスキップ
                    consistency_score = 0; // 整合性は評価不能
                } else {
                    const expectedVector = CLOCK_CATEGORIES[result.clock_category].vector;
                    const deviation = {
                        x: Math.abs(expectedVector.x - result.vector.x),
                        y: Math.abs(expectedVector.y - result.vector.y)
                    };
                    consistency_score = 100 - (deviation.x + deviation.y) * 50;
                }
                
                return {
                    category: result.clock_category,
                    confidence: Math.max(50, consistency_score),
                    reason: result.clock_reason,
                    depth: result.depth,
                    vector: result.vector,
                    consistency: consistency_score > 70
                };
            } catch (error) {
                console.error('AI分類エラー:', error);
                alert('AI分類エラー: ' + error.message);
                // フォールバック
                return {
                    category: 7,
                    confidence: 50,
                    reason: 'AI分類に失敗しました',
                    depth: 1,
                    vector: {x: 0, y: 0},
                    consistency: false
                };
            }
        }
        
        // === 経験値表示更新 ===
        function updateExpDisplay() {
            // 記録回数更新
            let recordCount;
            if (currentDay === 'practice') {
                // 練習用の場合は記録数を表示しない（0固定）
                recordCount = 0;
            } else {
                recordCount = records.filter(r => r.day === currentDay).length;
            }
            DOM.recordCount.forEach(el => el.textContent = recordCount);
            
            // レベル更新
            DOM.userLevel.forEach(el => el.textContent = userLevel);
            
            // 経験値バー更新（隠しパラメータとして動作）
            const expPercent = (userExp / 100) * 100;
            DOM.expBar.forEach(el => el.style.width = expPercent + '%');
            
            // デバッグ用（コンソールで確認可能）
            console.log(`Level: ${userLevel}, EXP: ${userExp}/100, Posts: ${totalPosts}`);
        }

        function updateAllViews() {
            updateRecordsList();
            updateOrganizedView();
            updateStatistics();
            updateExpDisplay();
        }

        // === 現在の日付の記録を取得 ===
        function getCurrentDayRecords() {
            return records.filter(record => record.day === currentDay);
        }

        // === 記録リスト更新（モニター1） ===
        function updateRecordsList() {
            const recordsList = document.getElementById('recordsList');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <p>まだ記録がありません<br>下のフォームから最初の記録を追加してください</p>
                    </div>
                `;
                return;
            }

            const html = dayRecords.map(record => {
                const category = AI_CATEGORIES[record.category] || AI_CATEGORIES.other;
                const timeStr = record.timestamp.toLocaleString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // 複数要素の表示
                let categoryDisplay = category.name;
                if (record.multipleElements && record.multipleElements.length > 1) {
                    const uniqueCategories = [...new Set(record.multipleElements.map(e => e.category))];
                    categoryDisplay = `${category.name} +${uniqueCategories.length - 1}要素`;
                }

                return `
                    <div class="record-item" data-id="${record.id}">
                        <div class="record-header">
                            <div class="record-header-left">
                                <div class="record-timestamp">${timeStr}</div>
                                <span class="record-category">${categoryDisplay}</span>
                            </div>
                            <div class="record-actions">
                                <button class="record-btn edit-btn" onclick="editRecord(${record.id})" title="編集">
                                    ✒️
                                </button>
                                <button class="record-btn delete-btn" onclick="deleteRecord(${record.id})" title="削除">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        <div class="record-text">${record.originalText}</div>
                    </div>
                `;
            }).join('');

            recordsList.innerHTML = html;
        }

        // === 整理ビュー更新（モニター2） ===
        function updateOrganizedView() {
            const organizedView = document.getElementById('organizedView');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                organizedView.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🤖</div>
                        <p>記録を追加すると<br>AI分析による12時計分類が表示されます</p>
                    </div>
                `;
                return;
            }

            // 12時計カテゴリ別に要素を集計
            const categoryElements = {};
            for (let i = 0; i <= 12; i++) {
                categoryElements[i] = [];
            }
            
            // 重複チェック用のマップ
            const uniqueElements = new Map();
            
            dayRecords.forEach(record => {
                // 長文記録で複数要素がある場合
                if (record.multipleElements && record.multipleElements.length > 0) {
                    record.multipleElements.forEach(elem => {
                        const key = `${elem.category}-${elem.content.toLowerCase().trim()}`;
                        if (!uniqueElements.has(key)) {
                            uniqueElements.set(key, true);
                            categoryElements[elem.category].push({
                                recordId: record.id,
                                originalText: record.originalText,
                                elementContent: elem.content,
                                elementReason: elem.reason,
                                weight: Math.max(1, Math.round(elem.weight)),
                                timestamp: record.timestamp
                            });
                        }
                    });
                } else {
                    // 短文記録の場合（従来通り）
                    const category = record.category || 0;
                    const key = `${category}-${record.originalText.toLowerCase().trim()}`;
                    if (!uniqueElements.has(key)) {
                        uniqueElements.set(key, true);
                        categoryElements[category].push({
                            recordId: record.id,
                            originalText: record.originalText,
                            elementContent: record.originalText,
                            elementReason: record.aiReason,
                            weight: 1,
                            timestamp: record.timestamp
                        });
                    }
                }
            });
            
            // HTML生成
            let html = '';
            for (let categoryId = 0; categoryId <= 12; categoryId++) {
                const elements = categoryElements[categoryId];
                if (elements.length === 0) continue;
                
                const category = AI_CATEGORIES[categoryId] || AI_CATEGORIES[0];
                const totalPoints = elements.reduce((sum, elem) => sum + elem.weight, 0);
                
                html += `
                    <div class="category-section">
                        <div class="category-header">
                            ${category.name} (${totalPoints}pt)
                        </div>
                        <div class="category-content">
                            ${elements.map((elem, index) => {
                                // 共有済みかチェック
                                const isShared = sharedLearnings.some(learning => 
                                    learning.text === elem.elementContent && 
                                    learning.userId === (currentUser ? currentUser.id : 'anonymous')
                                );
                                
                                return `
                                    <div class="category-item">
                                        <div class="element-display">
                                            <div class="element-text">${elem.elementContent}</div>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                ${isDeveloperMode ? (isShared ? `
                                                    <span style="color: rgba(76, 175, 80, 0.6); font-size: 0.9rem;">✅ 共有済み</span>
                                                ` : `
                                                    <span class="share-icon dev-only" onclick="quickShareLearning(${categoryId}, '${elem.elementContent.replace(/'/g, "\\'")}', '${elem.elementReason ? elem.elementReason.replace(/'/g, "\\'") : ''}')" title="開発モード: ローカル共有のみ" style="cursor: pointer; font-size: 1.1rem; opacity: 0.5;">
                                                        📤
                                                    </span>
                                                `) : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            organizedView.innerHTML = html || '<div class="empty-state"><p>分類された要素がありません</p></div>';
            
            // みんなの学びボタンを再追加（開発者モードのみ）
            if (isDeveloperMode) {
                const btnArea = document.getElementById('sharedLearningBtnArea');
                if (!btnArea) {
                    organizedView.innerHTML += `
                        <div id="sharedLearningBtnArea" class="dev-only" style="text-align: center; margin-top: 30px; padding: 20px 0;">
                            <button class="shared-learning-btn" onclick="toggleSharedLearning()" style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(254, 202, 87, 0.3) 100%); border: 2px dashed rgba(255, 107, 107, 0.5); padding: 15px 30px; border-radius: 30px; color: rgba(255, 255, 255, 0.8); font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; opacity: 0.7;" title="開発モード: ローカルデモ機能">
                                <span style="font-size: 24px; position: relative; opacity: 0.6;">
                                    <span style="position: absolute; left: -8px; top: -5px; opacity: 0.5;">💬</span>
                                    <span style="position: absolute; left: 5px; top: -8px; opacity: 0.6;">💬</span>
                                    <span style="position: relative;">💬</span>
                                </span>
                                <span style="font-size: 16px;">みんなの学び <span style="font-size: 0.8em; opacity: 0.7;">(Demo)</span></span>
                            </button>
                        </div>
                    `;
                }
            }
        }

        // === 統計更新 ===
        function updateStatistics() {
            // 基本統計
            document.getElementById('totalRecords').textContent = records.length;
            
            // 今日の記録数
            const today = new Date().toDateString();
            const todayCount = records.filter(r => r.timestamp.toDateString() === today).length;
            document.getElementById('todayRecords').textContent = todayCount;
            
            // AI処理済み数
            const aiCount = records.filter(r => r.aiProcessed).length;
            document.getElementById('aiProcessed').textContent = aiCount;

            // カテゴリ数
            const uniqueCategories = new Set(records.map(r => r.category)).size;
            document.getElementById('categoryCount').textContent = uniqueCategories;

            // 平均信頼度
            if (records.length > 0) {
                const avgConfidence = Math.round(
                    records.reduce((sum, r) => sum + r.confidence, 0) / records.length
                );
                document.getElementById('avgConfidence').textContent = avgConfidence + '%';
            }
        }

        // === 記録編集 ===
        function editRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;

            const recordElement = document.querySelector(`[data-id="${recordId}"]`);
            const textElement = recordElement.querySelector('.record-text');
            
            // 編集モードに切り替え
            recordElement.classList.add('edit-mode');
            textElement.innerHTML = `
                <textarea class="edit-textarea">${record.originalText}</textarea>
                <div class="edit-actions">
                    <button class="record-btn save-btn" onclick="saveRecord(${recordId})" title="保存">✓</button>
                    <button class="record-btn cancel-btn" onclick="cancelEdit(${recordId})" title="キャンセル">×</button>
                </div>
            `;
        }

        // === 記録保存 ===
        function saveRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;

            const recordElement = document.querySelector(`[data-id="${recordId}"]`);
            const textarea = recordElement.querySelector('.edit-textarea');
            const newText = textarea.value.trim();

            if (newText) {
                record.originalText = newText;
                updateAllViews();
                showStatus('✅ 記録を更新しました。', 'success');
            }
        }

        // === 編集キャンセル ===
        function cancelEdit(recordId) {
            updateAllViews();
        }

        // === 記録削除 ===
        function deleteRecord(recordId) {
            if (confirm('この記録を削除しますか？')) {
                records = records.filter(r => r.id !== recordId);
                updateAllViews();
                showStatus('🗑️ 記録を削除しました。', 'warning');
            }
        }

        // === AIによるレポートまとめ生成 ===
        async function generateAISummary(dayRecords, categoryGroups) {
            try {
                // 記録内容を整理
                const recordTexts = dayRecords.map(r => r.originalText).join('\n');
                
                // カテゴリ別の記録数を集計
                const categoryStats = [];
                let totalPoints = 0;
                for (const [categoryId, records] of Object.entries(categoryGroups)) {
                    const category = AI_CATEGORIES[categoryId];
                    const points = records.reduce((sum, record) => {
                        if (record.multipleElements) {
                            return sum + record.multipleElements.reduce((elemSum, elem) => 
                                elemSum + Math.max(1, Math.round(elem.weight)), 0);
                        }
                        return sum + 1;
                    }, 0);
                    totalPoints += points;
                    if (categoryId !== '0') { // 分類不能を除外
                        categoryStats.push(`${category.name}: ${points}ポイント`);
                    }
                }
                
                const prompt = `医学生の実習記録を読んで、指導医として自然で温かいコメントを書いてください。構造的なテンプレートは使わず、実際の指導医が書くような自然な文章でお願いします。

今日の実習内容:
${recordTexts}

学習カテゴリ別の記録:
${categoryStats.join(', ')}

${currentDay === '5' ? 
`最終日の実習を終えた医学生に向けて、以下の観点を含めた2-3段落の簡潔なコメントを書いてください：
- 今日の実習と全体を通しての成長を認める
- 実習全体を締めくくる温かいメッセージ
- 今後の医療者としての道への期待（1文程度）` :
`今日の実習について、以下の観点を含めた2-3段落の簡潔なコメントを書いてください：
- 今日の実習での頑張りを認める
- 特に印象的だった学習内容について触れる
- 次の実習への励まし（1文程度）`}

実際の指導医が医学生に声をかけるような、親しみやすく自然な口調（です・ます調）でお願いします。`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'あなたは経験豊富な臨床指導医です。医学生の実習記録を読んで、実際の指導現場で声をかけるような自然なコメントを書いてください。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error('AI API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('AI summary generation error:', error);
                // エラー時はデフォルトのフィードバックを返す
                const topCategory = Object.keys(categoryGroups)[0];
                const categoryName = topCategory ? AI_CATEGORIES[topCategory].name : '実習体験';
                // エラー時のデフォルトフィードバック
                const isFinalDay = currentDay === '5';
                if (isFinalDay) {
                    return `最終日、本当にお疲れ様でした！${dayRecords.length}件もの貴重な体験を記録され、特に${categoryName}に関する学びが深かったようですね。

5日間の実習を通して、あなたは確実に成長されました。この経験がこれからの医療者としての道のかけがえのない財産になることを確信しています。`;
                } else {
                    return `今日もお疲れ様でした！${dayRecords.length}件もの体験を記録され、特に${categoryName}に関する学びが多かったようですね。

実習での体験を振り返り、言葉にして残すことは、将来必ず大きな財産になります。明日もまた新しい発見が待っています。`;
                }
            }
        }
        
        // === レーダーチャート作成・更新 ===
        let radarChartInstance = null;
        
        function updateRadarChart() {
            // canvas要素の存在確認
            const canvas = document.getElementById('radarChart');
            if (!canvas) {
                console.error('レーダーチャートのcanvas要素が見つかりません');
                return;
            }
            
            // Chart.jsの存在確認
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsが読み込まれていません');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // チャートデータの準備（カテゴリ0を除外）
            // 12時を上（0度）に配置するため、順序を調整
            const labels = [];
            const data = [];
            
            // 現在の日付のカテゴリポイントを取得
            const dayKey = String(currentDay);
            const currentDayPoints = categoryPointsByDay[dayKey] || {};
            
            
            // 12時から始まって時計回りに配置
            const clockOrder = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            for (const i of clockOrder) {
                labels.push(CLOCK_CATEGORIES[i].name);
                data.push(currentDayPoints[i] || 0.5); // 初期値0.5
            }
            
            // 既存のチャートがあれば破棄
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }
            
            // 新しいチャートを作成
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '累積ポイント',
                        data: data,
                        backgroundColor: 'rgba(179, 157, 219, 0.2)',
                        borderColor: 'rgba(179, 157, 219, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(179, 157, 219, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(179, 157, 219, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: false,
                            min: 0,
                            suggestedMax: 5,
                            ticks: {
                                stepSize: 1,
                                backdropColor: 'transparent',
                                display: false
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 9
                                },
                                padding: 20,
                                callback: function(value) {
                                    // 長いラベルを改行
                                    if (value.includes('コミュニケーション')) {
                                        return ['コミュニ', 'ケーション'];
                                    }
                                    if (value.includes('患者に対する')) {
                                        return ['患者に対する', '問題解決能力'];
                                    }
                                    if (value.includes('社会医学')) {
                                        return ['社会医学/', '公衆衛生'];
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + 'ポイント';
                                }
                            }
                        }
                    }
                }
            });
            
            // レジェンドを更新
            updateRadarLegend();
        }
        
        function updateRadarLegend() {
            const legendContainer = document.getElementById('radarLegend');
            let legendHtml = '<div style="font-weight: bold; margin-bottom: 10px;">カテゴリ別累積ポイント</div>';
            
            // カテゴリ0を除外してポイントが多い順にソート
            const dayKey = String(currentDay);
            const currentDayPoints = categoryPointsByDay[dayKey] || {};
            
            const sortedCategories = [];
            for (let i = 1; i <= 12; i++) {
                if (currentDayPoints[i] > 0) {
                    sortedCategories.push({
                        id: i,
                        name: CLOCK_CATEGORIES[i].name,
                        icon: CLOCK_CATEGORIES[i].icon,
                        points: currentDayPoints[i]
                    });
                }
            }
            sortedCategories.sort((a, b) => b.points - a.points);
            
            sortedCategories.forEach(cat => {
                legendHtml += `
                    <div class="radar-legend-item">
                        <span style="margin-right: 8px;">${cat.icon}</span>
                        <span style="flex: 1;">${cat.name}</span>
                        <span style="font-weight: bold; color: #7e57c2;">${cat.points}pt</span>
                    </div>
                `;
            });
            
            if (sortedCategories.length === 0) {
                legendHtml += '<div style="color: #999; text-align: center;">まだ記録がありません</div>';
            }
            
            legendContainer.innerHTML = legendHtml;
        }
        
        // === 日次レポート生成 ===
        async function generateDailyReport() {
            const dailyReport = document.getElementById('dailyReport');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                showStatus(`${currentDay === 'practice' ? '練習用' : `${currentDay}日目`}の記録がありません。`, 'warning');
                return;
            }
            
            // 10投稿以上のチェック
            if (dayRecords.length < 10) {
                showStatus(`📝 レポート生成のために、さらに情報が必要です。10投稿以上を目指しましょう。（現在: ${dayRecords.length}件）`, 'warning');
                return;
            }

            // カテゴリ別に分類
            const categoryGroups = {};
            dayRecords.forEach(record => {
                const category = record.category || 'other';
                if (!categoryGroups[category]) {
                    categoryGroups[category] = [];
                }
                categoryGroups[category].push(record);
            });

            // レポート生成
            let reportHtml = `
                <div class="report-content">
                    <h4>📋 ${currentDay === 'practice' ? '練習用' : `${currentDay}日目`}の実習レポート</h4>
                    
                    <div class="report-section">
                        <h4>📊 概要</h4>
                        <p>${currentDay === 'practice' ? '練習' : `${currentDay}日目`}は${dayRecords.length}件の学習記録を作成しました。</p>
                        <p>記録されたカテゴリ: ${Object.keys(categoryGroups).length}項目</p>
                    </div>
            `;

            // LIST形式でカテゴリ別に表示（updateOrganizedViewと同じロジックを使用）
            // 12時計カテゴリ別に要素を集計
            const categoryElements = {};
            for (let i = 0; i <= 12; i++) {
                categoryElements[i] = [];
            }
            
            // 重複チェック用のマップ
            const uniqueElements = new Map();
            
            dayRecords.forEach(record => {
                // 長文記録で複数要素がある場合
                if (record.multipleElements && record.multipleElements.length > 0) {
                    record.multipleElements.forEach(elem => {
                        const key = `${elem.category}-${elem.content.toLowerCase().trim()}`;
                        if (!uniqueElements.has(key)) {
                            uniqueElements.set(key, true);
                            categoryElements[elem.category].push({
                                elementContent: elem.content,
                                elementReason: elem.reason,
                                weight: Math.max(1, Math.round(elem.weight))
                            });
                        }
                    });
                } else {
                    // 短文記録の場合
                    const category = record.category || 0;
                    const key = `${category}-${record.originalText.toLowerCase().trim()}`;
                    if (!uniqueElements.has(key)) {
                        uniqueElements.set(key, true);
                        categoryElements[category].push({
                            elementContent: record.originalText,
                            elementReason: record.aiReason,
                            weight: 1
                        });
                    }
                }
            });
            
            // カテゴリ別詳細をLIST形式で表示
            reportHtml += `
                <div class="report-section">
                    <h4>📝 学習内容（LIST形式）</h4>
                    <div class="report-list-content">
            `;
            
            for (let categoryId = 0; categoryId <= 12; categoryId++) {
                const elements = categoryElements[categoryId];
                if (elements.length === 0) continue;
                
                const category = AI_CATEGORIES[categoryId] || AI_CATEGORIES[0];
                const totalPoints = elements.reduce((sum, elem) => sum + elem.weight, 0);
                
                reportHtml += `
                    <div class="report-category-section">
                        <div class="report-category-header">
                            ${category.name} (${totalPoints}pt)
                        </div>
                        <div class="report-category-content">
                            ${elements.map(elem => `
                                <div class="report-category-item">
                                    <div class="report-element-text">• ${elem.elementContent}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            reportHtml += `
                    </div>
                </div>
            `;

            // AIによるまとめ生成
            showStatus('🤖 AIがレポートをまとめています...', 'info');
            const aiSummary = await generateAISummary(dayRecords, categoryGroups);
            
            reportHtml += `
                    <div class="report-section">
                        <h4>💡 AIによるフィードバック</h4>
                        <div class="ai-feedback">${aiSummary}</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadDayReportPDF('${currentDay}')" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; border: none; padding: 10px 25px; border-radius: 20px; font-size: 14px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                            📥 このレポートをPDFでダウンロード
                        </button>
                    </div>
                </div>
            `;

            // レポートを保存
            savedReports[currentDay] = reportHtml;
            
            // 保存されたレポートをすべて表示
            displayAllReports();
            
            // レーダーチャートを更新（表示状態は変えない）
            updateRadarChart();
            
            showStatus('📊 本日のレポートを生成しました！', 'success');
            
            // レポート生成ボーナス：練習用以外で10件以上の記録がある場合、初回のみレベルを3上げる
            const reportKey = `day_${currentDay}`;
            if (currentDay !== 'practice' && !generatedReports[reportKey]) {
                generatedReports[reportKey] = true;
                saveGameData();
                showStatus('🎁 10件以上の記録達成！ボーナス獲得！', 'success');
                setTimeout(() => {
                    addBonusLevels(3, 'デイリーレポート生成ボーナス！');
                }, 1000);
            } else if (currentDay === 'practice') {
                showStatus('📝 練習用レポートを生成しました（経験値なし）', 'info');
            }
        }

        // === 保存されたレポートをすべて表示 ===
        function displayAllReports() {
            const dailyReport = document.getElementById('dailyReport');
            let allReportsHtml = '';
            
            // 日付順にレポートを表示（練習用、1日目、2日目...）
            const orderedDays = ['practice', '1', '2', '3', '4', '5'];
            
            orderedDays.forEach(day => {
                if (savedReports[day]) {
                    const dayLabel = day === 'practice' ? '練習用' : `第${day}日目`;
                    const reportId = `report-${day}`;
                    
                    allReportsHtml += `
                        <div class="report-box">
                            <div class="report-box-header" onclick="toggleReport('${day}')">
                                <span class="report-box-title">📋 ${dayLabel}のレポート</span>
                                <span class="report-toggle-icon" id="toggle-icon-${day}">▼</span>
                            </div>
                            <div class="report-box-content" id="${reportId}" style="display: none;">
                                ${savedReports[day]}
                            </div>
                        </div>
                    `;
                }
            });
            
            // 生成されたレポートがない場合のメッセージ
            if (allReportsHtml === '' && !summaryReportHtml) {
                allReportsHtml = `
                    <div class="report-content">
                        <h4>📋 実習レポート</h4>
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>記録を追加してから<br>「レポート生成」ボタンを押すと<br>その日の体験をまとめたレポートが自動生成されます</p>
                        </div>
                    </div>
                `;
            }
            
            // 日付順レポートの後に総合レポートを追加
            dailyReport.innerHTML = allReportsHtml + (summaryReportHtml || '');
            
            // 現在の日付のレポートを自動的に開く
            if (savedReports[currentDay]) {
                toggleReport(currentDay);
            }
        }
        
        // === レポートの開閉 ===
        function toggleReport(day) {
            const reportContent = document.getElementById(`report-${day}`);
            const toggleIcon = document.getElementById(`toggle-icon-${day}`);
            
            if (reportContent.style.display === 'none') {
                // 他のレポートを閉じる
                document.querySelectorAll('.report-box-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.querySelectorAll('.report-toggle-icon').forEach(icon => {
                    icon.textContent = '▼';
                });
                
                // 選択したレポートを開く
                reportContent.style.display = 'block';
                toggleIcon.textContent = '▲';
            } else {
                // レポートを閉じる
                reportContent.style.display = 'none';
                toggleIcon.textContent = '▼';
            }
        }

        // === 総合レポート生成 ===
        async function generateSummaryReport() {
            // 全日程のカテゴリポイントを合算
            const totalPoints = {};
            for (let i = 0; i <= 12; i++) {
                totalPoints[i] = 0;
            }
            
            // 各日のポイントを合算
            const dayKeys = ['practice', '1', '2', '3', '4', '5'];
            dayKeys.forEach(day => {
                const dayPoints = categoryPointsByDay[day] || {};
                for (let i = 0; i <= 12; i++) {
                    totalPoints[i] += dayPoints[i] || 0;
                }
            });
            
            // 総合レポートを生成
            const summaryHtml = await generateSummaryReportContent(totalPoints);
            
            // 総合レポートのHTMLを保存
            summaryReportHtml = `
                <div class="report-box summary-report">
                    <div class="report-box-header" onclick="toggleReport('summary')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <span class="report-box-title">🏆 総合レポート（全${dayKeys.length - 1}日間）</span>
                        <span class="report-toggle-icon" id="toggle-icon-summary">▼</span>
                    </div>
                    <div class="report-box-content" id="report-summary" style="display: none;">
                        <div class="summary-radar-container" style="text-align: center; margin-bottom: 20px;">
                            <canvas id="summaryRadarChart" width="200" height="200" style="max-width: 200px; height: auto;"></canvas>
                        </div>
                        ${summaryHtml}
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="downloadSummaryReportPDF()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                📥 PDFダウンロード
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // レポートエリアを更新（displayAllReportsが総合レポートも含めて適切な順序で表示）
            displayAllReports();
            
            // 総合レポートを開く
            setTimeout(() => {
                toggleReport('summary');
                // レーダーチャートを描画
                drawSummaryRadarChart(totalPoints);
            }, 100);
            
            showStatus('🏆 総合レポートを生成しました！', 'success');
        }
        
        // === 総合レーダーチャート描画 ===
        function drawSummaryRadarChart(totalPoints) {
            const canvas = document.getElementById('summaryRadarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // データ準備
            const labels = [];
            const data = [];
            const clockOrder = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            
            for (const i of clockOrder) {
                labels.push(CLOCK_CATEGORIES[i].name);
                data.push(totalPoints[i] || 0.5);
            }
            
            // 既存のチャートがあれば破棄
            if (window.summaryRadarChartInstance) {
                window.summaryRadarChartInstance.destroy();
            }
            
            // 新しいチャートを作成
            window.summaryRadarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '総合実績',
                        data: data,
                        backgroundColor: 'rgba(147, 51, 234, 0.2)',
                        borderColor: 'rgba(147, 51, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(147, 51, 234, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(147, 51, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: Math.max(...data) * 1.2,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // === 総合レーダーチャートを表示 ===
        function showSummaryRadarChart(totalPoints) {
            // 一時的に総合ポイントを表示
            const originalPoints = categoryPointsByDay[currentDay];
            const dayKey = String(currentDay);
            
            // 総合ポイントを一時的に設定
            categoryPointsByDay['summary'] = totalPoints;
            const originalDay = currentDay;
            currentDay = 'summary';
            
            // チャートを更新
            updateRadarChart();
            
            // 3秒後に元に戻す
            setTimeout(() => {
                currentDay = originalDay;
                delete categoryPointsByDay['summary'];
                updateRadarChart();
            }, 3000);
            
            showStatus('📊 総合チャートを3秒間表示します', 'info');
        }
        
        // === 総合レポートコンテンツ生成 ===
        async function generateSummaryReportContent(totalPoints) {
            // カテゴリ別のポイントランキング
            const ranking = [];
            for (let i = 1; i <= 12; i++) { // 0（分類不能）を除外
                if (totalPoints[i] > 0) {
                    ranking.push({
                        category: i,
                        name: AI_CATEGORIES[i].name,
                        points: totalPoints[i]
                    });
                }
            }
            ranking.sort((a, b) => b.points - a.points);
            
            // 現在の日付とユーザー名を取得
            const today = new Date().toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const userName = currentUser ? currentUser.name : '匿名ユーザー';
            
            let html = `
                <div class="report-content">
                    <div class="report-header" style="text-align: center; margin-bottom: 30px; padding: 20px 0; border-bottom: 2px solid #e0e0e0;">
                        <h3 style="margin: 0 0 10px 0;">地域医療実習 総合レポート</h3>
                        <p style="margin: 5px 0; color: #666;">作成日: ${today}</p>
                        <p style="margin: 5px 0; color: #666;">氏名: ${userName}</p>
                    </div>
                    
                    <h4>🏆 実習全体の総合評価</h4>
                    
                    <div class="report-section">
                        <h4>📊 獲得ポイントランキング</h4>
                        <ol>
                            ${ranking.map((item, index) => {
                                let medal = '';
                                let style = '';
                                if (index === 0) {
                                    medal = '🥇';
                                    style = 'font-size: 1.3em; font-weight: bold; color: #FFD700;';
                                } else if (index === 1) {
                                    medal = '🥈';
                                    style = 'font-size: 1.2em; font-weight: bold; color: #C0C0C0;';
                                } else if (index === 2) {
                                    medal = '🥉';
                                    style = 'font-size: 1.1em; font-weight: bold; color: #CD7F32;';
                                }
                                return `<li style="${style}">${medal} ${item.name}: ${item.points}ポイント</li>`;
                            }).join('')}
                        </ol>
                    </div>
                    
                    <div class="report-section">
                        <h4>🎯 学習達成度</h4>
                        <p>総記録数: ${records.length}件</p>
                        <p>最終レベル: Lv.${userLevel}</p>
                        <p>総獲得ポイント: ${ranking.reduce((sum, item) => sum + item.points, 0)}ポイント</p>
                    </div>
                `;
            
            // 4象限マトリクスの集計
            const matrixData = calculateMatrixData(totalPoints);
            
            // AIによる4象限サマリー
            if (records.length > 0) {
                const matrixSummary = await generateMatrixSummary(matrixData, records);
                html += `
                    <div class="report-section">
                        <h4>🗺️ 4象限マトリクス分析</h4>
                        ${matrixSummary}
                    </div>
                `;
                
                const aiFeedback = await generateSummaryAIFeedback(ranking, records.length, records);
                html += `
                    <div class="report-section">
                        <h4>📄 総合学習記録</h4>
                        <div class="ai-feedback">${aiFeedback}</div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }
        
        // === 4象限マトリクスの計算 ===
        function calculateMatrixData(totalPoints) {
            // 各カテゴリを4象限に分類
            const matrix = {
                'Clinical-Technical': {
                    categories: [3, 4, 5, 6], // 医学知識、診察・手技、問題解決、統合的臨床
                    points: 0,
                    name: '臨床×technical skill'
                },
                'Clinical-NonTechnical': {
                    categories: [7, 8], // 多職種連携、コミュニケーション
                    points: 0,
                    name: '臨床×non-technical skill'
                },
                'Social-Technical': {
                    categories: [10, 12], // 保健・福祉、社会医学/公衆衛生
                    points: 0,
                    name: '社会×technical skill'
                },
                'Social-NonTechnical': {
                    categories: [1, 2, 9, 11], // 医療倫理、地域医療、一般教養、行政
                    points: 0,
                    name: '社会×non-technical skill'
                }
            };
            
            // 各象限のポイントを集計
            for (const quadrant in matrix) {
                matrix[quadrant].categories.forEach(cat => {
                    matrix[quadrant].points += totalPoints[cat] || 0;
                });
            }
            
            return matrix;
        }
        
        // === 4象限マトリクスサマリー生成 ===
        async function generateMatrixSummary(matrixData, allRecords) {
            // APIキーチェック
            checkApiKey();
            if (!OPENAI_API_KEY) {
                return '<p>AIサマリーを生成できません（APIキー未設定）</p>';
            }
            
            // 各象限の記録を収集
            const quadrantRecords = {
                'Clinical-Technical': [],
                'Clinical-NonTechnical': [],
                'Social-Technical': [],
                'Social-NonTechnical': []
            };
            
            // 記録を象限ごとに分類
            allRecords.forEach(record => {
                if (record.category) {
                    for (const quadrant in matrixData) {
                        if (matrixData[quadrant].categories.includes(record.category)) {
                            quadrantRecords[quadrant].push(record.text);
                            break;
                        }
                    }
                }
            });
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{
                            role: 'system',
                            content: '医学実習の記録を分析し、各領域での学習内容を客観的に記述する報告書作成者です。事実に基づいた冷静な観察と分析を心がけ、過度な感情表現は避けてください。'
                        }, {
                            role: 'user',
                            content: `以下の実習記録を4つの領域別に整理し、それぞれ200字程度で学習内容をまとめてください。
実際に行った活動、観察した事象、得られた知見を中心に、報告書として適切な文体で記述してください。

【臨床×technical skill の記録】
${quadrantRecords['Clinical-Technical'].join('\n')}

【臨床×non-technical skill の記録】
${quadrantRecords['Clinical-NonTechnical'].join('\n')}

【社会×technical skill の記録】
${quadrantRecords['Social-Technical'].join('\n')}

【社会×non-technical skill の記録】
${quadrantRecords['Social-NonTechnical'].join('\n')}

以下のJSON形式で、各領域の学習内容を客観的に記述してください：
{
  "clinical_technical": "診察・手技に関する学習内容の客観的記述",
  "clinical_nontechnical": "チーム医療・コミュニケーションに関する学習内容の記述",
  "social_technical": "地域保健・公衆衛生活動に関する学習内容の記述",
  "social_nontechnical": "地域医療・倫理的側面に関する学習内容の記述"
}`
                        }],
                        temperature: 0.3,
                        max_tokens: 800,
                        response_format: { type: "json_object" }
                    })
                });
                
                const data = await response.json();
                const summaryData = JSON.parse(data.choices[0].message.content);
                
                // HTML形式で整形（縦並び）
                return `
                    <div class="matrix-summary" style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #4285f4;">
                            <h5 style="margin: 0 0 10px 0; color: #4285f4;">🏥 臨床×technical skill</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                ${summaryData.clinical_technical || 'データがありません'}
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #ea4335;">
                            <h5 style="margin: 0 0 10px 0; color: #ea4335;">🤝 臨床×non-technical skill</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                ${summaryData.clinical_nontechnical || 'データがありません'}
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #34a853;">
                            <h5 style="margin: 0 0 10px 0; color: #34a853;">🌍 社会×technical skill</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                ${summaryData.social_technical || 'データがありません'}
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #fbbc04;">
                            <h5 style="margin: 0 0 10px 0; color: #fbbc04;">🏘️ 社会×non-technical skill</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                ${summaryData.social_nontechnical || 'データがありません'}
                            </p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Matrix summary generation error:', error);
                // エラー時は記録数に基づく簡易サマリーを表示
                return `
                    <div class="matrix-summary" style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #4285f4;">
                            <h5 style="margin: 0 0 10px 0; color: #4285f4;">🏥 臨床×technical skill（${matrixData['Clinical-Technical'].points}ポイント）</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                医学知識の習得、診察手技の実践、患者さんへの問題解決、そして統合的な臨床能力の向上に関する学習記録が${quadrantRecords['Clinical-Technical'].length}件ありました。実習を通じて、座学で学んだ知識を実際の臨床現場で応用する機会を得られました。
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #ea4335;">
                            <h5 style="margin: 0 0 10px 0; color: #ea4335;">🤝 臨床×non-technical skill（${matrixData['Clinical-NonTechnical'].points}ポイント）</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                多職種連携やコミュニケーションスキルに関する学習記録が${quadrantRecords['Clinical-NonTechnical'].length}件ありました。医療チームの一員として、看護師、薬剤師、リハビリスタッフなど様々な職種との協働を経験し、チーム医療の重要性を実感しました。
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #34a853;">
                            <h5 style="margin: 0 0 10px 0; color: #34a853;">🌍 社会×technical skill（${matrixData['Social-Technical'].points}ポイント）</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                保健・福祉制度や公衆衛生に関する学習記録が${quadrantRecords['Social-Technical'].length}件ありました。地域医療の現場で、医療だけでなく福祉や行政との連携の重要性を学び、社会医学的な視点から患者さんを支援する方法を理解しました。
                            </p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #fbbc04;">
                            <h5 style="margin: 0 0 10px 0; color: #fbbc04;">🏘️ 社会×non-technical skill（${matrixData['Social-NonTechnical'].points}ポイント）</h5>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: #333;">
                                医療倫理、地域医療の特性、一般教養、行政との関わりに関する学習記録が${quadrantRecords['Social-NonTechnical'].length}件ありました。地域に根ざした医療の在り方や、医療者としての倫理観、地域社会との関わり方について深い洞察を得ました。
                            </p>
                        </div>
                    </div>
                `;
            }
        }
        
        // === AIによる総合学習記録生成 ===
        async function generateSummaryAIFeedback(ranking, totalRecords, allRecords) {
            try {
                // カテゴリー別に記録を整理
                const categorizedRecords = {};
                allRecords.forEach(record => {
                    if (record.category) {
                        const categoryName = CATEGORY_MAP[record.category] || `カテゴリー${record.category}`;
                        if (!categorizedRecords[categoryName]) {
                            categorizedRecords[categoryName] = [];
                        }
                        categorizedRecords[categoryName].push(record.text);
                    }
                });
                
                // 全記録を結合してナラティブを作成
                const allTexts = allRecords.map(r => r.text).join('\n');
                
                const prompt = `以下は地域医療実習での全記録です。これらの記録から、実習期間を通じてどのような体験をし、何を発見し、どう成長したのかを、400字程度の自然な文章で描写してください。

【実習記録】
${allTexts}

形式的な報告書ではなく、実習の日々で実際に起きたことや感じたことが伝わるような、生き生きとした記述をお願いします。
「〜を学びました」という定型的な表現を避け、具体的なエピソードや気づきの瞬間を中心に、実習の物語を紡いでください。`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'あなたは医学生の実習記録を読み込み、そこから浮かび上がる体験の物語を描き出すライターです。記録の断片から、実習期間中の発見、驚き、成長の瞬間を見つけ出し、読む人が実習の現場を追体験できるような文章を書いてください。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.9,
                        max_tokens: 600
                    })
                });

                if (!response.ok) {
                    throw new Error('AI API request failed');
                }

                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('Summary report generation error:', error);
                const topCategories = ranking.slice(0, 3).map(item => item.name).join('、');
                return `本実習では${totalRecords}件の学習体験を記録しました。主な学習分野は${topCategories}であり、地域医療の現場において幅広い経験を積むことができました。

臨床面では、診察手技の実践や患者とのコミュニケーション、多職種連携の重要性を学びました。社会医学的側面では、地域の保健・福祉制度や公衆衛生活動の実際を体験し、医療の社会的役割について理解を深めました。

実習全体を通じて、医学知識の臨床応用、チーム医療の実践、地域医療の特性理解など、医師として必要な基本的能力の基盤を構築することができました。`;
            }
        }

        // === 次の日へ進む ===
        // === 前の日へ機能 ===
        function previousDay() {
            const currentDayElement = document.getElementById('currentDay');
            if (currentDayElement) {
                const currentDay = parseInt(currentDayElement.textContent) || 1;
                if (currentDay > 1) {
                    currentDayElement.textContent = currentDay - 1;
                    showStatus(`Day ${currentDay - 1}に戻りました`, 'success');
                    // 表示を更新
                    updateAllViews();
                } else {
                    showStatus('これ以上前の日には戻れません', 'error');
                }
            }
        }

        async function advanceDay() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showStatus('学生名を入力してください。', 'error');
                return;
            }

            try {
                // ローカルで日数を進める
                const currentDayElement = document.getElementById('currentDay');
                const currentDayText = currentDayElement.textContent;
                const currentDayNum = parseInt(currentDayText.replace('日目', '')) || 1;
                const nextDay = Math.min(currentDayNum + 1, 5);
                
                currentDayElement.textContent = nextDay + '日目';
                showStatus(`✅ ${nextDay}日目に進みました！`, 'success');

                // GAS連携（バックグラウンド）
                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'advanceDay',
                            studentName: studentName
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('日次進行結果:', result);
                    }
                } catch (gasError) {
                    console.log('GAS日次進行スキップ:', gasError);
                }

            } catch (error) {
                console.error('日次進行エラー:', error);
                showStatus('❌ 日次進行に失敗しました。', 'error');
            }
        }


        // === ステータス表示 ===
        // === AI分析理由の表示/非表示 ===
        function toggleReason(categoryId, index) {
            const reasonElement = document.getElementById(`reason-${categoryId}-${index}`);
            if (reasonElement) {
                if (reasonElement.style.display === 'none') {
                    // 他の開いている理由を閉じる
                    document.querySelectorAll('.element-reason').forEach(el => {
                        el.style.display = 'none';
                    });
                    reasonElement.style.display = 'block';
                } else {
                    reasonElement.style.display = 'none';
                }
            }
        }

        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // 5秒後に消去
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // === ドロップダウン開閉 ===
        function toggleDayDropdown() {
            const dropdown = document.getElementById('dayDropdown');
            dropdown.classList.toggle('active');
        }

        // === 日付選択機能 ===
        function selectDay(day) {
            currentDay = day;
            
            // ドロップダウンのアクティブ状態を更新
            document.querySelectorAll('.day-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // ラベルを更新
            const dayLabel = document.getElementById('currentDayLabel');
            dayLabel.textContent = day === 'practice' ? '練習用' : `${day}日目`;
            
            // ドロップダウンを閉じる
            document.getElementById('dayDropdown').classList.remove('active');
            
            // 表示を更新
            updateAllViews();
            
            // レーダーチャートを常に更新
            updateRadarChart();
            
            // REPORTモニターがアクティブな場合は、レポート表示も更新
            if (currentMonitor === 'monitor3') {
                setTimeout(() => {
                    displayAllReports();
                }, 100);
            }
        }


        // === 長文サンプル記録追加（開発用） ===
        async function addLongSampleRecord() {
            const longSampleTexts = [
                // 内科系
                "本日の内科外来実習では、高血圧と糖尿病を合併した70歳男性患者の問診から診察、検査オーダーまでの一連の流れを学んだ。特に印象的だったのは、指導医が患者の生活背景を丁寧に聞き取り、食事内容や運動習慣、ストレス要因などを総合的に評価していたことである。また、血圧測定の際には白衣高血圧の可能性も考慮し、家庭血圧の記録を確認していた。診察後のカンファレンスでは、薬物治療の選択についてディスカッションを行い、ACE阻害薬と利尿薬の併用による治療方針を学んだ。患者さんへの説明では、専門用語を避けてわかりやすく伝えることの大切さを実感した。",
                
                // 救急
                "救急外来での実習で、交通外傷による多発外傷患者の初期対応を見学した。Primary SurveyのABCDEアプローチを実際に目の当たりにし、気道確保、呼吸状態の評価、循環動態のチェックが迅速に行われる様子を学んだ。同時に看護師がバイタルサインの測定を行い、放射線技師がポータブルX線撮影の準備をしており、チーム医療の重要性を痛感した。FAST検査で腹腔内出血が疑われたため、緊急手術の適応となり、患者さんの家族への説明も同時並行で行われた。救急医の先生からは、「救急では常に最悪を想定して動くこと」「できることから確実にやっていくこと」の重要性を教わった。また、トリアージの考え方や、限られたリソースを最大限に活用するための判断力の必要性も学んだ。患者さんの命を左右する現場の緊張感と責任の重さを身をもって感じた一日だった。",
                
                // 精神科
                "精神科の外来実習で、うつ病患者さんの診察を見学した。この方は3ヶ月前から不眠、食欲不振、意欲低下が続いており、仕事にも行けなくなっているとのことだった。診察では、患者さんの話をじっくりと傾聴し、急かさずに対話を進める先生の姿勢が印象的だった。HAM-DやBDIなどの評価尺度を用いた症状評価や、自殺念慮の有無の確認など、系統的な問診の方法を学んだ。薬物療法についてはSSRIの作用機序や副作用、効果が現れるまでの時間について説明があり、患者さんにもわかりやすく伝えていた。また、認知行動療法の基本的な考え方や、社会的サポートの重要性についても説明を受けた。精神科医療においては、患者さんとの信頼関係の構築が何よりも大切であり、共感的な態度で接することの重要性を学んだ。",
                
                // 小児科
                "小児科病棟での実習で、喘息発作で入院した5歳の男児のケアに関わった。子どもへの問診は保護者を通じて行うことが多いが、子ども本人からも症状を聞き出すコミュニケーションスキルの重要性を学んだ。聴診では成人とは異なる呼吸音の特徴があり、wheezingの聴取方法を教わった。吸入療法の実施では、子どもが怖がらないようにキャラクターのマスクを使用したり、遊びの要素を取り入れたりする工夫を見学した。また、保護者への病状説明では、不安を和らげながら正確な情報を伝えるバランスが重要であることを認識した。小児科では医療技術だけでなく、子どもの発達段階に応じた対応や、家族全体をケアする視点が必要であることを実感した。薬物投与量の計算では体重あたりで行うため、正確な体重測定の重要性も学んだ。",
                
                // 外科
                "外科手術室での実習で、胆嚢摘出術を見学した。手術前のタイムアウトでは、患者確認、手術部位の確認、アレルギーの有無など、医療安全の観点から重要な確認事項を全員で共有する様子を学んだ。手洗いの方法や清潔操作の重要性について実践的に教わり、術野の清潔を保つことの意味を理解した。腹腔鏡手術では、モニターを見ながらの繊細な操作技術に感銘を受けた。執刀医、第一助手、器械出し看護師、外回り看護師がそれぞれの役割を果たし、円滑に手術が進行していく様子からチーム医療の重要性を再認識した。術中の解剖学的ランドマークの確認方法や、出血への対処法なども学ぶことができた。術後の申し送りでは、手術所見や術後管理の注意点が詳細に伝達されており、継続的な患者ケアの重要性を感じた。",
                
                // 産婦人科
                "産婦人科外来で妊婦健診を見学した。妊娠20週の初産婦さんの健診では、超音波検査で胎児の成長を確認し、推定体重の計算方法を学んだ。胎児の各部位の計測や、羊水量の評価、胎盤の位置確認など、系統的な観察方法を教わった。母体の体重増加や血圧管理の重要性についても説明を受けた。妊娠糖尿病のスクリーニング検査の意義や、妊娠高血圧症候群の早期発見のポイントなども学習した。患者さんへの説明では、専門用語を使わずに、模型や図を用いてわかりやすく説明する工夫を見学した。また、妊婦さんの不安に寄り添い、質問しやすい雰囲気作りをすることの大切さを実感した。出生前診断についての相談もあり、倫理的な配慮を持って情報提供を行う必要性を学んだ。",
                
                // 整形外科
                "整形外科の手術で人工膝関節置換術を見学した。術前計画では、X線画像から骨切りの角度や人工関節のサイズを決定する過程を学んだ。手術では大腿骨と脛骨の骨切りを正確に行い、人工関節を設置する手技を観察した。骨セメントの使用方法や、軟部組織のバランス調整の重要性について説明を受けた。術中の出血コントロールや、感染予防のための無菌操作の徹底も印象的だった。リハビリテーション科との連携も重要で、術翌日から理学療法士による可動域訓練が開始されることを学んだ。術後の疼痛管理では、硬膜外麻酔や神経ブロックなど、様々な鎮痛法が組み合わされていた。患者さんのQOL向上のために、手術適応の判断から術後のリハビリまで、包括的な治療計画が必要であることを理解した。",
                
                // 在宅医療
                "訪問診療に同行し、在宅医療の実際を体験した。寝たきりの高齢患者さんの自宅を訪問し、バイタルサインの測定、褥瘡の処置、経管栄養の管理などを見学した。限られた医療資源の中で、いかに質の高い医療を提供するかという工夫を学んだ。家族の介護負担についても評価し、介護サービスの調整や、レスパイトケアの提案なども行っていた。訪問看護師、ケアマネジャー、ヘルパーなど多職種との情報共有の重要性を実感した。在宅での看取りについても話し合いがあり、患者さんと家族の意向を尊重しながら、最期まで尊厳を持って過ごせるようサポートすることの大切さを学んだ。病院とは異なる環境での医療提供には様々な制約があるが、患者さんが住み慣れた場所で療養できることの意義を深く理解できた。",
                
                // 緩和ケア
                "緩和ケア病棟で終末期の癌患者さんのケアを学んだ。疼痛評価では数値評価スケールだけでなく、表情や体動からも痛みを評価する方法を教わった。オピオイドの使用方法、レスキュー薬の調整、副作用対策など、疼痛コントロールの実際を詳しく学習した。しかし緩和ケアは疼痛管理だけでなく、呼吸困難、嘔気、倦怠感など様々な症状への対応が必要であることを知った。また、患者さんの精神的苦痛やスピリチュアルペインにも配慮し、傾聴や共感的な対応の重要性を学んだ。家族へのケアも重要で、病状説明や意思決定支援、グリーフケアなども緩和ケアチームの役割であることを理解した。多職種カンファレンスでは、医師、看護師、薬剤師、臨床心理士、MSWなどがそれぞれの視点から患者さんと家族を支える方法を議論していた。",
                
                // リハビリテーション
                "リハビリテーション科で脳梗塞後の患者さんの機能回復訓練を見学した。理学療法では、片麻痺の評価方法としてBrunnstrom stageやFugl-Meyer評価を学んだ。歩行訓練では平行棒から始まり、歩行器、杖歩行へと段階的に進める過程を観察した。作業療法では、上肢機能の改善だけでなく、更衣や食事などのADL訓練も重要であることを学んだ。言語聴覚士による失語症や嚥下障害の評価と訓練も見学し、コミュニケーション能力や安全な食事摂取の重要性を認識した。リハビリカンファレンスでは、患者さんの目標設定を多職種で共有し、在宅復帰に向けた具体的な計画を立てていた。家族指導も重要で、自宅での介助方法や住環境整備のアドバイスも行われていた。リハビリテーションは単なる機能訓練ではなく、患者さんのQOL向上と社会復帰を目指す包括的なアプローチであることを深く理解した。"
            ];
            
            const randomText = longSampleTexts[Math.floor(Math.random() * longSampleTexts.length)];
            document.getElementById('experienceText').value = randomText;
            
            // 送信処理を呼び出し
            await submitExperience();
            
            showStatus('📝 長文サンプルを追加しました', 'info');
        }
        
        // === サンプル記録追加（開発用） ===
        async function addSampleRecords() {
            const sampleTexts = [
                // 医学知識（3時）
                "糖尿病の三大合併症について学んだ。",
                "抗生剤の使い分けについて理解した。",
                "心不全のNYHA分類を覚えた。",
                "肺炎の重症度分類A-DROPを学習した。",
                "脳梗塞の病型分類について整理できた。",
                "甲状腺機能検査の解釈方法を学んだ。",
                "電解質異常の症状と対処法を理解した。",
                "貧血の鑑別診断について勉強した。",
                "腎機能検査の見方を習得した。",
                "肝機能障害の原因について学んだ。",
                
                // 診察・手技（4時）
                "初めて静脈採血を成功させた。",
                "心音の聴診で異常音を聴き分けた。",
                "腹部触診の手順を実践した。",
                "血圧測定を正確に行えるようになった。",
                "神経学的所見の取り方を練習した。",
                "眼底鏡の使い方を教わった。",
                "耳鏡での鼓膜観察を体験した。",
                "皮下注射の手技を見学した。",
                "心電図の装着方法を覚えた。",
                "尿検査の手順を実施した。",
                
                // コミュニケーション（8時）
                "患者さんの不安に寄り添う対話ができた。",
                "病状説明で分かりやすい言葉を心がけた。",
                "患者家族との面談に同席した。",
                "傾聴の姿勢で患者さんの話を聞いた。",
                "検査の必要性を丁寧に説明した。",
                "患者さんの価値観を尊重した対応を学んだ。",
                "bad newsの伝え方について考察した。",
                "共感的な声かけの重要性を実感した。",
                "患者さんとの信頼関係構築を意識した。",
                "非言語的コミュニケーションの大切さを学んだ。",
                
                // 多職種連携（7時）
                "看護師との情報共有の重要性を認識した。",
                "薬剤師による服薬指導を見学した。",
                "理学療法士のリハビリ計画を学んだ。",
                "栄養士との栄養カンファレンスに参加した。",
                "MSWと退院調整について話し合った。",
                "検査技師から検査の注意点を教わった。",
                "作業療法士の評価方法を見学した。",
                "言語聴覚士による嚥下評価を学んだ。",
                "臨床心理士のカウンセリングを見学した。",
                "多職種カンファレンスで意見交換した。",
                
                // 問題解決能力（5時）
                "鑑別診断を系統的に考える訓練をした。",
                "検査計画を論理的に立案した。",
                "治療方針の優先順位を考察した。",
                "症例の問題点を整理して提示した。",
                "エビデンスに基づいた判断を心がけた。",
                "臨床推論のプロセスを実践した。",
                "患者の個別性を考慮した対応を検討した。",
                "リスクとベネフィットを比較検討した。",
                "診療ガイドラインの活用方法を学んだ。",
                "critical thinkingの重要性を認識した。",
                
                // 医療倫理（1時）
                "インフォームドコンセントの実際を見学した。",
                "患者の自己決定権について考えた。",
                "医療倫理の4原則を再確認した。",
                "守秘義務の重要性を認識した。",
                "DNARの意思確認場面に立ち会った。",
                "患者の尊厳について深く考察した。",
                "医療者の責任について学んだ。",
                "倫理的ジレンマへの対処を議論した。",
                "患者の最善の利益について検討した。",
                "プライバシー保護の実践を学んだ。",
                
                // 地域医療（2時）
                "在宅医療の現場を見学した。",
                "訪問看護の役割を理解した。",
                "地域包括ケアシステムについて学んだ。",
                "介護保険制度の概要を勉強した。",
                "地域の医療資源について調査した。",
                "かかりつけ医の役割を認識した。",
                "病診連携の重要性を学んだ。",
                "地域住民の健康ニーズを考察した。",
                "訪問診療の実際を体験した。",
                "地域医療の課題について議論した。",
                
                // 保健・福祉（10時）
                "介護認定の仕組みを学んだ。",
                "福祉制度の活用方法を理解した。",
                "社会資源の種類と利用法を勉強した。",
                "障害者支援制度について学習した。",
                "生活保護制度の概要を理解した。",
                "介護サービスの種類を整理した。",
                "福祉用具の選定について学んだ。",
                "ケアマネジャーの役割を理解した。",
                "介護予防の重要性を認識した。",
                "福祉施設の機能を見学した。",
                
                // 統合的臨床（6時）
                "複数の疾患を持つ患者の管理を学んだ。",
                "全人的医療の実践を見学した。",
                "bio-psycho-socialモデルを意識した。",
                "継続的な患者フォローの重要性を認識した。",
                "予防医学的アプローチを実践した。",
                "患者中心の医療について考察した。",
                "EBMとNBMの統合を学んだ。",
                "包括的な健康評価を実施した。",
                "慢性疾患管理の要点を理解した。",
                "総合診療の視点を養った。",
                
                // その他の体験
                "医学英語の論文を読解した。",
                "症例発表のスライドを作成した。",
                "医療安全について学習した。",
                "感染対策の基本を実践した。",
                "電子カルテの使い方を習得した。",
                "医療経済について考察した。",
                "研究倫理について学んだ。",
                "統計解析の基礎を勉強した。",
                "文献検索の方法を習得した。",
                "プレゼンテーション技術を向上させた。"
            ];
            
            showStatus('🔧 サンプル記録を追加中...', 'info');
            
            // ランダムに10件選択
            const shuffled = sampleTexts.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 10);
            
            for (let i = 0; i < selected.length; i++) {
                document.getElementById('experienceText').value = selected[i];
                await submitExperience();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            showStatus('✅ 10件のサンプル記録を追加しました（開発用）', 'success');
        }
        
        // === ログイン処理 ===
        function handleLogin(event) {
            event.preventDefault();
            
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            // 簡易的な認証（実際の実装では適切な認証を行う）
            if (id && password) {
                // 開発者モードチェック
                isDeveloperMode = (id === 'dev' || id === 'developer' || id === 'admin');
                
                // ユーザー情報を保存
                currentUser = {
                    id: id,
                    loginTime: new Date(),
                    isDeveloper: isDeveloperMode
                };
                localStorage.setItem('multasUser', JSON.stringify(currentUser));
                
                // ログインモーダルを閉じる
                document.getElementById('loginModal').style.display = 'none';
                
                // ユーザー情報を表示
                showUserInfo();
                
                // 開発者モードUI更新
                updateDeveloperUI();
                
                // 初期化処理を続行
                initializeApp();
            } else {
                document.getElementById('loginError').textContent = 'IDとパスワードを入力してください';
            }
        }
        
        // === 開発者モードUI更新 ===
        function updateDeveloperUI() {
            const devElements = document.querySelectorAll('.dev-only');
            devElements.forEach(el => {
                // ボタンとドロップダウンオプションで表示方法を変える
                if (el.classList.contains('btn-secondary')) {
                    el.style.display = isDeveloperMode ? 'block' : 'none';
                } else if (el.classList.contains('day-option')) {
                    el.style.display = isDeveloperMode ? 'block' : 'none';
                } else {
                    el.style.display = isDeveloperMode ? 'block' : 'none';
                }
            });
            
            // 開発者モードの場合、コンソールにメッセージ表示
            if (isDeveloperMode) {
                console.log('🔧 開発者モードが有効です');
                console.log('利用可能なショートカット:');
                console.log('- Ctrl+Shift+S: サンプル10投稿を追加');
                console.log('- Ctrl+Shift+L: 長文サンプル投稿を追加');
                console.log('- Ctrl+Shift+X: ログアウト');
                console.log('利用可能な機能:');
                console.log('- 練習用日付選択');
                console.log('- サンプル投稿ボタン');
            }
        }
        
        // === ユーザー情報表示 ===
        function showUserInfo() {
            if (currentUser) {
                const userInfo = document.getElementById('userInfo');
                const devBadge = isDeveloperMode ? ' <span style="color: #ff6b6b;">[DEV]</span>' : '';
                userInfo.innerHTML = `
                    <span class="user-name-clickable" onclick="toggleUserPopup()">${currentUser.id}${devBadge}</span>
                    <div id="userPopup" class="user-popup">
                        <div class="user-popup-content">
                            <p style="font-weight: bold; color: #333;">現在ログイン中です</p>
                            <p>ユーザー: ${currentUser.id}</p>
                            <p>レベル: ${userLevel}</p>
                            <button class="logout-btn" onclick="confirmLogout()">ログアウト</button>
                        </div>
                    </div>
                `;
                userInfo.style.display = 'block';
                userInfo.style.position = 'relative';
            }
        }

        // === ユーザーポップアップ切り替え ===
        function toggleUserPopup() {
            const popup = document.getElementById('userPopup');
            if (popup) {
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // === ログアウト確認 ===
        function confirmLogout() {
            // ポップアップを閉じる
            const userPopup = document.getElementById('userPopup');
            if (userPopup) {
                userPopup.style.display = 'none';
            }
            
            const message = `ログアウトしますか？\n\n【現在の状態】\nユーザー: ${currentUser.id}\nレベル: ${userLevel}\n総記録数: ${records.length}\n\nログアウトすると再度ログインが必要になります。\n記録データは保存されます。`;
            
            if (confirm(message)) {
                // データを保存
                saveGameData();
                // 成功メッセージ
                showStatus('ログアウトしました', 'info');
                // ユーザー情報を削除
                localStorage.removeItem('multasUser');
                // 少し待ってからリロード
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }
        
        // === APIキーリセット ===
        function resetApiKey() {
            const newKey = prompt('新しいOpenAI APIキーを入力してください:', OPENAI_API_KEY);
            if (newKey !== null) {
                OPENAI_API_KEY = newKey;
                localStorage.setItem('multasApiKey', newKey);
                showStatus('APIキーを更新しました', 'success');
            }
        }
        
        
        // === アプリケーション初期化 ===
        function initializeApp() {
            // DOM要素のキャッシュを初期化
            initDOMCache();
            
            // 初期表示設定
            document.getElementById('stats-monitor1').style.display = 'block';
            
            // 初期経験値表示
            updateExpDisplay();
            updateAllViews();
            
            // Enter キーでの送信
            document.getElementById('experienceText').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    submitExperience();
                }
            });

            // テキストエリアの動的リサイズ
            const textarea = document.getElementById('experienceText');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // ドロップダウンの外側クリックで閉じる
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.day-display')) {
                    document.getElementById('dayDropdown').classList.remove('active');
                }
                
                // 理由吹き出しの外側をクリックしたら閉じる
                if (!e.target.closest('.element-reason') && !e.target.classList.contains('reason-icon')) {
                    document.querySelectorAll('.element-reason').forEach(el => {
                        el.style.display = 'none';
                    });
                }
                
                // ユーザーポップアップの外側をクリックしたら閉じる
                const userPopup = document.getElementById('userPopup');
                if (userPopup && userPopup.style.display === 'block') {
                    if (!e.target.closest('.user-popup') && !e.target.classList.contains('user-name-clickable')) {
                        userPopup.style.display = 'none';
                    }
                }
            });
        }
        
        // === 初期化 ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MULTAs システム初期化');
            
            // デバッグ用：各種リセットコマンド
            document.addEventListener('keydown', function(e) {
                // Shift+Ctrl+R: 完全リセット
                if (e.shiftKey && e.ctrlKey && e.key === 'R') {
                    if (confirm('ゲームデータをリセットしますか？（レベル、経験値、レポート記録）')) {
                        localStorage.removeItem('multasGameData');
                        userLevel = 1;
                        userExp = 0;
                        totalPosts = 0;
                        generatedReports = {};
                        updateExpDisplay();
                        showStatus('🔄 ゲームデータをリセットしました', 'success');
                    }
                }
                
                // Ctrl+Shift+0: レベルとカテゴリポイントをリセット（デバッグ用）
                if (e.ctrlKey && e.shiftKey && e.key === '0') {
                    userLevel = 1;
                    userExp = 0;
                    // 全日付のカテゴリポイントをリセット
                    const dayKeys = ['practice', '1', '2', '3', '4', '5'];
                    dayKeys.forEach(day => {
                        categoryPointsByDay[day] = {};
                        for (let i = 0; i <= 12; i++) {
                            categoryPointsByDay[day][i] = 0;
                        }
                    });
                    saveGameData();
                    updateExpDisplay();
                    updateRadarChart();
                    showStatus('🔧 レベルとカテゴリポイントをリセットしました（デバッグ）', 'warning');
                }
                
                // Ctrl+Shift+数字: 特定レベルに設定（デバッグ用）
                if (e.ctrlKey && e.shiftKey && e.key >= '1' && e.key <= '9') {
                    const targetLevel = parseInt(e.key);
                    userLevel = targetLevel;
                    userExp = 0;
                    saveGameData();
                    updateExpDisplay();
                    showStatus(`🔧 レベルを${targetLevel}に設定しました（デバッグ）`, 'warning');
                }
                
                // Ctrl+Shift+X: ログアウト（デバッグ用）
                if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                    if (confirm('ログアウトしますか？')) {
                        localStorage.removeItem('multasUser');
                        location.reload();
                    }
                }
                
                // Ctrl+Shift+S: サンプル10投稿を追加（開発用）
                if (e.ctrlKey && e.shiftKey && e.key === 'S' && isDeveloperMode) {
                    addSampleRecords();
                }
                
                // Ctrl+Shift+L: 長文サンプル投稿を追加（開発用）
                if (e.ctrlKey && e.shiftKey && e.key === 'L' && isDeveloperMode) {
                    addLongSampleRecord();
                }
            });
            
            // 保存されたユーザー情報をチェック
            const savedUser = localStorage.getItem('multasUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // 開発者モードフラグを復元
                isDeveloperMode = currentUser.isDeveloper || false;
                showUserInfo();
                updateDeveloperUI();
                initializeApp();
            } else {
                // 初回ログインの場合、ログインモーダルを表示
                document.getElementById('loginModal').style.display = 'flex';
            }
            
            // ユーザーのいいね情報を読み込み
            const savedLikes = localStorage.getItem('userLikes');
            if (savedLikes) {
                userLikes = JSON.parse(savedLikes);
            }
        });
        
        // === みんなの学び機能 ===
        let sharedLearnings = [];
        let userLikes = {};
        
        function loadSharedLearnings() {
            // デモ用のサンプルデータ
            const sampleLearnings = [
                {
                    id: 'learn_001',
                    text: '訪問診療で患者さんの生活環境を見ることで、病院では気づけない問題に気づけました',
                    category: 2, // 地域医療
                    categoryName: '地域医療',
                    timestamp: new Date().getTime() - 1000 * 60 * 30,
                    likes: 12,
                    isTeacher: false,
                    anonymous: true
                },
                {
                    id: 'learn_002',
                    text: '多職種カンファレンスで、それぞれの専門職の視点の違いを実感。チーム医療の重要性を学びました',
                    category: 7, // 多職種連携
                    categoryName: '多職種連携',
                    timestamp: new Date().getTime() - 1000 * 60 * 60,
                    likes: 18,
                    isTeacher: true,
                    teacherComment: 'とても良い気づきですね！',
                    anonymous: true
                },
                {
                    id: 'learn_003',
                    text: '血圧測定の手技を練習。患者さんへの声かけの大切さも同時に学べました',
                    category: 4, // 診察・手技
                    categoryName: '診察・手技',
                    timestamp: new Date().getTime() - 1000 * 60 * 120,
                    likes: 8,
                    isTeacher: false,
                    anonymous: true
                }
            ];
            
            // LocalStorageから読み込み（実装時）
            const savedLearnings = localStorage.getItem('sharedLearnings');
            if (savedLearnings) {
                sharedLearnings = JSON.parse(savedLearnings);
            } else {
                sharedLearnings = sampleLearnings;
            }
            
            displaySharedLearnings();
        }
        
        function displaySharedLearnings() {
            const container = document.getElementById('sharedLearningContent');
            
            if (sharedLearnings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🤝</div>
                        <p>他の実習生の学びがここに表示されます<br>あなたの記録も匿名で共有できます</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="shared-learnings-list">';
            
            sharedLearnings.forEach(learning => {
                const timeAgo = getTimeAgo(learning.timestamp);
                const liked = userLikes[learning.id] || false;
                const isMyPost = learning.userId === (currentUser ? currentUser.id : 'anonymous');
                
                html += `
                    <div class="shared-learning-item" style="background: ${isMyPost ? '#f3e5ff' : 'white'}; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); ${isMyPost ? 'border: 2px solid #e1bee7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 5px;">
                                    <div style="color: #666; font-size: 0.8rem;">
                                        <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">${learning.categoryName}</span>
                                        <span style="margin-left: 10px;">${timeAgo}</span>
                                        ${isMyPost ? '<span style="margin-left: 10px; color: #9c27b0; font-weight: bold;">✨ あなたの投稿</span>' : ''}
                                    </div>
                                    <!-- リアクションボタン -->
                                    <div style="display: flex; gap: 5px; align-items: center; margin-left: auto;">
                                        ${isDeveloperMode ? `
                                        <button onclick="toggleLike('${learning.id}')" style="background: ${liked ? 'rgba(255, 64, 129, 0.3)' : 'rgba(245, 245, 245, 0.5)'}; color: ${liked ? 'rgba(255, 255, 255, 0.7)' : 'rgba(102, 102, 102, 0.5)'}; border: 1px dashed rgba(200, 200, 200, 0.5); padding: 4px 10px; border-radius: 15px; cursor: pointer; transition: all 0.3s; font-size: 13px; white-space: nowrap; opacity: 0.6;" title="開発モード: ローカルストレージのみ">
                                            ❤️ いいね ${learning.likes > 0 ? `(${learning.likes})` : ''}
                                        </button>
                                        <button onclick="addReaction('${learning.id}', '🙋')" style="background: ${learning.reactions && learning.reactions[currentUser?.id || 'anonymous']?.includes('🙋') ? 'rgba(76, 175, 80, 0.3)' : 'rgba(240, 240, 240, 0.5)'}; color: ${learning.reactions && learning.reactions[currentUser?.id || 'anonymous']?.includes('🙋') ? 'rgba(255, 255, 255, 0.7)' : 'rgba(51, 51, 51, 0.5)'}; border: 1px dashed rgba(200, 200, 200, 0.5); padding: 4px 10px; border-radius: 15px; cursor: pointer; font-size: 13px; white-space: nowrap; opacity: 0.6;" title="開発モード: ローカルストレージのみ">
                                            🙋 私も経験した! ${learning.reactions ? `(${Object.keys(learning.reactions).length})` : ''}
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div style="font-size: 0.95rem; line-height: 1.5; margin: 10px 0;">
                                    ${learning.text}
                                </div>
                                ${learning.isTeacher && learning.teacherComment ? `
                                    <div style="background: #fff3e0; padding: 8px 12px; border-radius: 8px; margin-top: 10px;">
                                        <span style="color: #ff6f00; font-weight: bold;">👨‍🏫 指導医より：</span>
                                        <span style="color: #666;">${learning.teacherComment}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // 自分の記録を共有するボタン
            // 開発者モードの場合のみ共有ボタンを表示
            if (isDeveloperMode) {
                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="shareMyLearning()" class="btn-secondary" style="background: rgba(126, 87, 194, 0.3); border: 2px dashed rgba(126, 87, 194, 0.5); color: rgba(255, 255, 255, 0.8); opacity: 0.7;" title="開発モード: ローカル共有のみ">
                            📤 自分の学びを共有する
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            updateSharedStats();
        }
        
        function toggleLike(learningId) {
            const learning = sharedLearnings.find(l => l.id === learningId);
            if (!learning) return;
            
            if (userLikes[learningId]) {
                // いいねを取り消し
                userLikes[learningId] = false;
                learning.likes--;
            } else {
                // いいねを追加
                userLikes[learningId] = true;
                learning.likes++;
                showStatus('👍 いいねしました！', 'success');
            }
            
            // 保存と再表示
            localStorage.setItem('sharedLearnings', JSON.stringify(sharedLearnings));
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
            displaySharedLearnings();
        }
        
        function shareMyLearning() {
            if (records.length === 0) {
                showStatus('共有する記録がありません', 'info');
                return;
            }
            
            // 最新の記録から選択（実装簡略化のため最新のものを自動選択）
            const latestRecord = records[records.length - 1];
            
            if (confirm(`以下の記録を匿名で共有しますか？\n\n「${latestRecord.text}」\n\nカテゴリ: ${AI_CATEGORIES[latestRecord.category].name}`)) {
                const newLearning = {
                    id: 'learn_' + Date.now(),
                    text: latestRecord.text,
                    category: latestRecord.category,
                    categoryName: AI_CATEGORIES[latestRecord.category].name,
                    timestamp: new Date().getTime(),
                    likes: 0,
                    isTeacher: false,
                    anonymous: true,
                    userId: currentUser ? currentUser.id : 'anonymous'
                };
                
                sharedLearnings.unshift(newLearning);
                localStorage.setItem('sharedLearnings', JSON.stringify(sharedLearnings));
                
                showStatus('📤 学びを共有しました！', 'success');
                displaySharedLearnings();
            }
        }
        
        // === LISTから直接共有する機能 ===
        function quickShareLearning(categoryId, elementContent, elementReason) {
            const category = AI_CATEGORIES[categoryId];
            
            // 既に共有済みかチェック
            const alreadyShared = sharedLearnings.some(learning => 
                learning.text === elementContent && 
                learning.userId === (currentUser ? currentUser.id : 'anonymous')
            );
            
            if (alreadyShared) {
                showStatus('✅ この学びは既に共有済みです', 'info');
                return;
            }
            
            // 確認ダイアログ（シンプルに）
            if (confirm(`この学びを共有しますか？\n\n「${elementContent}」`)) {
                const newLearning = {
                    id: 'learn_' + Date.now(),
                    text: elementContent,
                    category: categoryId,
                    categoryName: category.name,
                    timestamp: new Date().getTime(),
                    likes: 0,
                    isTeacher: false,
                    anonymous: true,
                    userId: currentUser ? currentUser.id : 'anonymous',
                    aiReason: elementReason
                };
                
                sharedLearnings.unshift(newLearning);
                localStorage.setItem('sharedLearnings', JSON.stringify(sharedLearnings));
                
                showStatus('📤 学びを共有しました！', 'success');
                
                // みんなの学び画面が開いている場合は更新
                if (currentMonitor === 'monitor4') {
                    displaySharedLearnings();
                }
                
                // LIST画面も更新して共有済みマークを表示
                if (currentMonitor === 'monitor2') {
                    displayOrganizedView();
                }
            }
        }
        
        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `${days}日前`;
            if (hours > 0) return `${hours}時間前`;
            if (minutes > 0) return `${minutes}分前`;
            return 'たった今';
        }
        
        function updateSharedStats() {
            // 共有数といいね数を更新
            const sharedCountEl = document.getElementById('sharedCount');
            const likeCountEl = document.getElementById('likeCount');
            
            if (sharedCountEl) {
                sharedCountEl.textContent = sharedLearnings.length;
            }
            
            if (likeCountEl) {
                const totalLikes = Object.values(userLikes).filter(liked => liked).length;
                likeCountEl.textContent = totalLikes;
            }
        }
        
        // === みんなの学びモーダル切り替え ===
        function toggleSharedLearning() {
            if (currentMonitor === 'monitor4') {
                // 現在みんなの学び画面なら、前の画面に戻る
                switchMonitor('monitor2');
            } else {
                // みんなの学び画面を開く
                switchMonitor('monitor4');
                // タブボタンも更新
                document.querySelectorAll('.monitor-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }
        }
        
        // === LISTに戻る ===
        function backToList() {
            switchMonitor('monitor2');
            // LISTタブをアクティブに
            document.querySelectorAll('.monitor-tab').forEach((tab, index) => {
                tab.classList.remove('active');
                if (index === 1) tab.classList.add('active'); // LISTは2番目のタブ
            });
        }
        
        // === リアクション追加 ===
        function addReaction(learningId, reaction) {
            const learning = sharedLearnings.find(l => l.id === learningId);
            if (!learning) return;
            
            // リアクションを初期化
            if (!learning.reactions) {
                learning.reactions = {};
            }
            
            // ユーザーのリアクションを記録
            const userId = currentUser ? currentUser.id : 'anonymous';
            if (!learning.reactions[userId]) {
                learning.reactions[userId] = [];
            }
            
            // 同じリアクションがあれば削除、なければ追加
            const reactionIndex = learning.reactions[userId].indexOf(reaction);
            if (reactionIndex > -1) {
                learning.reactions[userId].splice(reactionIndex, 1);
                showStatus('リアクションを取り消しました', 'info');
            } else {
                learning.reactions[userId].push(reaction);
                showStatus('🙋 私も経験しました！', 'success');
            }
            
            // 空の配列は削除
            if (learning.reactions[userId].length === 0) {
                delete learning.reactions[userId];
            }
            
            // 保存と再表示
            localStorage.setItem('sharedLearnings', JSON.stringify(sharedLearnings));
            displaySharedLearnings();
        }
        
        // === PDF出力機能 ===
        async function downloadSummaryReportPDF() {
            showStatus('📄 PDF生成中...', 'info');
            showLoadingIndicator('PDFを生成しています...');
            
            try {
                // jsPDFインスタンスを作成（A4サイズ）
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // 日本語フォントの設定（ブラウザ標準フォントを使用）
                pdf.setFont('helvetica');
                
                // ページ設定
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;
                
                // === 表紙ページ ===
                pdf.setFontSize(24);
                pdf.text('MULTAs 実習レポート', pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 15;
                pdf.setFontSize(16);
                pdf.text('Medical University Learning and Training Assessment system', pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 30;
                pdf.setFontSize(14);
                pdf.text(`学生ID: ${currentUser.id}`, margin, yPosition);
                yPosition += 10;
                pdf.text(`レベル: ${userLevel}`, margin, yPosition);
                yPosition += 10;
                pdf.text(`総記録数: ${records.length}件`, margin, yPosition);
                yPosition += 10;
                pdf.text(`作成日: ${new Date().toLocaleDateString('ja-JP')}`, margin, yPosition);
                
                // === 総合統計ページ ===
                pdf.addPage();
                yPosition = margin;
                pdf.setFontSize(18);
                pdf.text('総合統計', margin, yPosition);
                yPosition += 15;
                
                // カテゴリ別集計
                const categoryStats = {};
                records.forEach(record => {
                    const cat = record.category || 0;
                    categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                });
                
                pdf.setFontSize(12);
                Object.entries(categoryStats).forEach(([catId, count]) => {
                    const category = AI_CATEGORIES[catId];
                    if (category && count > 0) {
                        pdf.text(`${category.name}: ${count}件`, margin, yPosition);
                        yPosition += 8;
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                    }
                });
                
                // === レーダーチャート ===
                const radarCanvas = document.getElementById('summaryRadarChart');
                if (radarCanvas) {
                    try {
                        const imgData = await html2canvas(radarCanvas).then(canvas => canvas.toDataURL('image/png'));
                        pdf.addPage();
                        pdf.setFontSize(18);
                        pdf.text('学習バランス（レーダーチャート）', pageWidth / 2, margin, { align: 'center' });
                        pdf.addImage(imgData, 'PNG', (pageWidth - 120) / 2, margin + 10, 120, 120);
                    } catch (error) {
                        console.error('レーダーチャート画像化エラー:', error);
                    }
                }
                
                // === 日別詳細レポート ===
                const days = ['1', '2', '3', '4', '5'];
                for (const day of days) {
                    const dayRecords = records.filter(r => String(r.day) === day);
                    if (dayRecords.length > 0) {
                        pdf.addPage();
                        yPosition = margin;
                        pdf.setFontSize(18);
                        pdf.text(`${day}日目のレポート（${dayRecords.length}件）`, margin, yPosition);
                        yPosition += 15;
                        
                        pdf.setFontSize(10);
                        dayRecords.forEach((record, index) => {
                            if (yPosition > pageHeight - margin * 2) {
                                pdf.addPage();
                                yPosition = margin;
                            }
                            
                            const category = AI_CATEGORIES[record.category] || AI_CATEGORIES[0];
                            const time = new Date(record.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                            
                            pdf.text(`${index + 1}. [${time}] ${category.name}`, margin, yPosition);
                            yPosition += 6;
                            
                            // テキストを折り返し
                            const lines = pdf.splitTextToSize(record.originalText, pageWidth - margin * 2);
                            lines.forEach(line => {
                                if (yPosition > pageHeight - margin) {
                                    pdf.addPage();
                                    yPosition = margin;
                                }
                                pdf.text(line, margin + 5, yPosition);
                                yPosition += 5;
                            });
                            yPosition += 5;
                        });
                    }
                }
                
                // === 考察・振り返り欄 ===
                pdf.addPage();
                yPosition = margin;
                pdf.setFontSize(18);
                pdf.text('考察・振り返り', margin, yPosition);
                yPosition += 15;
                
                pdf.setFontSize(12);
                pdf.text('実習を通しての学び：', margin, yPosition);
                yPosition += 40;
                
                pdf.text('今後の課題：', margin, yPosition);
                yPosition += 40;
                
                pdf.text('指導医へのコメント：', margin, yPosition);
                
                // === 署名欄 ===
                yPosition = pageHeight - margin * 3;
                pdf.line(margin, yPosition, margin + 60, yPosition);
                pdf.text('学生署名', margin, yPosition + 5);
                
                pdf.line(pageWidth - margin - 60, yPosition, pageWidth - margin, yPosition);
                pdf.text('日付', pageWidth - margin - 60, yPosition + 5);
                
                // PDFを保存
                const fileName = `MULTAs_Report_${currentUser.id}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                hideLoadingIndicator();
                showStatus('✅ PDFのダウンロードが完了しました', 'success');
                
            } catch (error) {
                console.error('PDF生成エラー:', error);
                hideLoadingIndicator();
                showStatus('❌ PDF生成中にエラーが発生しました', 'error');
                
                // フォールバック：ブラウザの印刷機能を使用
                fallbackPrintReport();
            }
        }
        
        // === 日別レポートPDFダウンロード ===
        async function downloadDayReportPDF(day) {
            showStatus('📄 PDF生成中...', 'info');
            showLoadingIndicator('PDFを生成しています...');
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                pdf.setFont('helvetica');
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;
                
                // タイトル
                pdf.setFontSize(20);
                pdf.text(`MULTAs ${day === 'practice' ? '練習用' : `${day}日目`}実習レポート`, pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 20;
                pdf.setFontSize(12);
                pdf.text(`学生ID: ${currentUser.id}`, margin, yPosition);
                yPosition += 8;
                pdf.text(`作成日: ${new Date().toLocaleDateString('ja-JP')}`, margin, yPosition);
                yPosition += 15;
                
                // 記録詳細
                const dayRecords = records.filter(r => String(r.day) === String(day));
                pdf.setFontSize(14);
                pdf.text(`記録数: ${dayRecords.length}件`, margin, yPosition);
                yPosition += 15;
                
                // カテゴリ別記録
                pdf.setFontSize(10);
                dayRecords.forEach((record, index) => {
                    if (yPosition > pageHeight - margin * 2) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                    
                    const category = AI_CATEGORIES[record.category] || AI_CATEGORIES[0];
                    const time = new Date(record.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    
                    pdf.text(`${index + 1}. [${time}] ${category.name}`, margin, yPosition);
                    yPosition += 6;
                    
                    const lines = pdf.splitTextToSize(record.originalText, pageWidth - margin * 2);
                    lines.forEach(line => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(line, margin + 5, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 5;
                });
                
                // レーダーチャート（可能な場合）
                const radarCanvas = document.getElementById('radarChart');
                if (radarCanvas && radarCanvas.style.display !== 'none') {
                    try {
                        pdf.addPage();
                        pdf.setFontSize(16);
                        pdf.text('学習バランス', pageWidth / 2, margin, { align: 'center' });
                        
                        const imgData = await html2canvas(radarCanvas).then(canvas => canvas.toDataURL('image/png'));
                        pdf.addImage(imgData, 'PNG', (pageWidth - 100) / 2, margin + 10, 100, 100);
                    } catch (error) {
                        console.error('レーダーチャート画像化エラー:', error);
                    }
                }
                
                // PDFを保存
                const fileName = `MULTAs_DayReport_${currentUser.id}_Day${day}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                hideLoadingIndicator();
                showStatus('✅ PDFのダウンロードが完了しました', 'success');
                
            } catch (error) {
                console.error('PDF生成エラー:', error);
                hideLoadingIndicator();
                showStatus('❌ PDF生成中にエラーが発生しました', 'error');
            }
        }
        
        // === 印刷用フォールバック ===
        function fallbackPrintReport() {
            const printWindow = window.open('', '_blank');
            
            // 総合レポートの内容を取得
            const reportContent = document.getElementById('report-summary');
            if (!reportContent) {
                showStatus('❌ レポートが見つかりません', 'error');
                return;
            }
            
            // 印刷用HTMLを構築
            const printHTML = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>地域医療実習 総合レポート</title>
    <style>
        @media print {
            body {
                margin: 0;
                padding: 20mm;
                font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
                line-height: 1.8;
                color: #333;
            }
            
            .no-print {
                display: none !important;
            }
            
            .report-header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #333;
            }
            
            .report-header h3 {
                font-size: 24px;
                margin: 0 0 15px 0;
            }
            
            .report-header p {
                margin: 5px 0;
                font-size: 14px;
            }
            
            .report-section {
                margin: 25px 0;
                page-break-inside: avoid;
            }
            
            .report-section h4 {
                font-size: 18px;
                margin: 15px 0 10px 0;
                padding-bottom: 5px;
                border-bottom: 1px solid #ddd;
            }
            
            .matrix-summary {
                margin: 20px 0;
            }
            
            .matrix-summary > div {
                margin: 15px 0;
                padding: 15px;
                border-left: 3px solid #666;
                background: #f8f9fa;
            }
            
            .matrix-summary h5 {
                font-size: 16px;
                margin: 0 0 10px 0;
            }
            
            .ai-feedback {
                background: #f0f8ff;
                padding: 15px;
                border-radius: 5px;
                margin: 15px 0;
            }
            
            ol {
                padding-left: 30px;
            }
            
            .summary-radar-container {
                display: none !important;
            }
            
            @page {
                size: A4;
                margin: 20mm;
            }
        }
        
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            line-height: 1.8;
            color: #333;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .report-section {
            margin: 20px 0;
        }
        
        .report-section h4 {
            font-size: 18px;
            margin: 15px 0 10px 0;
            color: #444;
        }
        
        button {
            display: none;
        }
        
        /* 開発者モード用ゴーストボタンスタイル */
        .ghost-reaction {
            position: relative;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.1) 5px,
                rgba(255, 255, 255, 0.1) 10px
            );
        }
    </style>
</head>
<body>
    ${reportContent.innerHTML}
    <script>
        // 不要な要素を削除
        document.querySelectorAll('button').forEach(el => el.remove());
        document.querySelector('.summary-radar-container')?.remove();
        
        // 印刷ダイアログを自動的に開く
        setTimeout(() => {
            window.print();
            // 印刷完了後にウィンドウを閉じる
            window.onafterprint = () => {
                window.close();
            };
        }, 500);
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            showStatus('📄 PDFダウンロード画面を開きました', 'success');
        }
    </script>
</body>
</html>