# MULTAs 設計書

## 1. アーキテクチャ設計

### 1.1 全体構成
```
┌─────────────────────────────────────┐
│          ログイン画面                │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│          メインアプリ                │
├─────────────────────────────────────┤
│  ┌─────────┬─────────┬─────────┐  │
│  │  LOG    │  LIST   │ REPORT  │  │ ← タブナビゲーション
│  └─────────┴─────────┴─────────┘  │
│  ┌─────────────────────────────┐    │
│  │      画面コンテンツ          │    │
│  │  - LOG: 投稿フォーム+履歴   │    │
│  │  - LIST: AI分類結果        │    │
│  │  - REPORT: チャート+レポート│    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 1.2 コンポーネント構成

#### UIコンポーネント
1. **Header** - ユーザー情報、日付選択
2. **TabBar** - 3つのタブ（LOG/LIST/REPORT）
3. **Monitor** - 各画面のコンテナ
4. **InputForm** - 投稿入力（LOG専用）
5. **RecordList** - 投稿履歴表示
6. **CategoryList** - 分類結果表示
7. **RadarChart** - 12時計チャート
8. **ReportView** - レポート表示

#### 機能モジュール
1. **AuthManager** - 認証管理
2. **DataStore** - データ永続化
3. **AIService** - OpenAI API連携
4. **ChartService** - Chart.js管理
5. **ReportGenerator** - レポート生成
6. **LevelSystem** - レベル/経験値

## 2. 画面設計

### 2.1 LOG画面
```
┌───────────────────────────┐
│ [1日目▼] admin [DEV]     │ ← ヘッダー
├───────────────────────────┤
│ LOG │ LIST │ REPORT       │ ← タブ
├───────────────────────────┤
│ 記録: 0  [======] Lv.1    │ ← ステータス
├───────────────────────────┤
│ ┌───────────────────────┐ │
│ │ 📝                    │ │
│ │ まだ記録がありません  │ │ ← 空状態
│ │                       │ │
│ └───────────────────────┘ │
│                           │
│ ┌───────────────────────┐ │
│ │ 実習で体験したこと... │ │ ← 入力欄
│ │                    [>]│ │
│ └───────────────────────┘ │
└───────────────────────────┘
```

### 2.2 LIST画面
```
┌───────────────────────────┐
│ 記録: 5  [████──] Lv.2    │
├───────────────────────────┤
│ ■ コミュニケーション(2)   │
│ ┌───────────────────────┐ │
│ │ 患者さんとの対話で... │ │
│ │ AI: 傾聴の重要性     │ │
│ └───────────────────────┘ │
│                           │
│ ■ 診察・手技(3)          │
│ ┌───────────────────────┐ │
│ │ 血圧測定を初めて...  │ │
│ └───────────────────────┘ │
└───────────────────────────┘
```

### 2.3 REPORT画面
```
┌───────────────────────────┐
│   12時計分類 体験チャート  │
│  ┌────────────────────┐    │
│  │     レーダー       │    │
│  │      チャート      │    │
│  └────────────────────┘    │
│ [🤖 レポート生成]         │
│ [📊 総合レポート生成]     │
├───────────────────────────┤
│ 📋 本日の実習レポート     │
│ ┌───────────────────────┐ │
│ │ （AI生成レポート）   │ │
│ └───────────────────────┘ │
└───────────────────────────┘
```

## 3. データフロー設計

### 3.1 投稿フロー
```
ユーザー入力
    ↓
入力検証
    ↓
AI分類リクエスト
    ↓
ローカル保存
    ↓
UI更新（3画面）
    ↓
経験値計算
    ↓
レベル判定
```

### 3.2 表示更新フロー
```
タブ切り替え
    ↓
currentMonitor更新
    ↓
対象画面の表示
    ↓
他画面の非表示
    ↓
データ再描画
```

## 4. 状態管理設計

### 4.1 グローバル状態
```javascript
const AppState = {
  // ユーザー関連
  currentUser: null,
  isDeveloperMode: false,
  
  // データ関連
  records: [],
  recordIdCounter: 0,
  
  // UI状態
  currentMonitor: 'monitor1',
  currentDay: 1,
  
  // ゲーム要素
  userLevel: 1,
  userExp: 0,
  totalPosts: 0,
  
  // 集計データ
  categoryPointsByDay: {},
  generatedReports: {}
}
```

### 4.2 ローカル状態
- 入力フォームの値
- ローディング状態
- エラーメッセージ
- モーダル表示状態

## 5. セキュリティ設計

### 5.1 APIキー管理
- LocalStorageに暗号化なしで保存（制限事項）
- 入力時の長さ検証（51文字）
- 使用時の存在確認

### 5.2 個人情報保護
- 投稿時の自動検出
- 警告表示
- 強制的なマスキング（オプション）

## 6. エラー処理設計

### 6.1 API エラー
- タイムアウト（30秒）
- レート制限
- ネットワークエラー
→ フォールバック: カテゴリ7（多職種連携）

### 6.2 データエラー
- LocalStorage容量超過
- データ破損
→ 自動バックアップと復旧

## 7. パフォーマンス設計

### 7.1 初期ロード最適化
- Critical CSS のインライン化
- JavaScript の遅延ロード
- 画像の遅延ロード

### 7.2 ランタイム最適化
- DOM要素のキャッシュ
- イベントリスナーの最適化
- 不要な再レンダリング防止

## 8. v3への改善提案

### 8.1 アーキテクチャ
- **コンポーネント分離**: 各機能を独立したモジュールに
- **イベント駆動**: 画面間の結合を疎に
- **TypeScript導入**: 型安全性の確保

### 8.2 UI/UX
- **画面遷移アニメーション**: スムーズな切り替え
- **プログレッシブ対応**: PWA化
- **ダークモード**: 目の疲れ軽減

### 8.3 機能
- **オフライン対応**: Service Worker
- **音声入力**: 実習中の利便性
- **画像添付**: 視覚的記録

### 8.4 技術スタック案
- **フレームワーク**: React or Vue.js
- **状態管理**: Zustand or Pinia
- **スタイリング**: Tailwind CSS
- **ビルドツール**: Vite
- **テスト**: Vitest + Testing Library